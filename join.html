<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hook Arena — Join</title>
<style>
  html,body{height:100%;margin:0;background:#0b0f17}
  .mpPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #334155;border-radius:12px;padding:16px 18px;color:#e5e7eb;min-width:340px}
  .title{font:18px/1.3 system-ui,sans-serif;margin-bottom:10px}
  .row{margin:8px 0}
  .btn{background:#1f2937;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 14px;cursor:pointer}
  .btn.primary{background:#2563eb;border-color:#1d4ed8}
  .diag{position:fixed;left:10px;bottom:10px;color:#9ca3af;font:12px/1.3 ui-monospace,monospace;max-width:80vw;white-space:pre-wrap}
</style>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="join" class="mpPanel">
    <div class="title">Присоединиться к игре</div>
    <div class="row">Код комнаты: <input id="code" class="btn" style="width:80px;text-align:center"></div>
    <div class="row">Сервер:
      <select id="server" class="btn">
        <option value="0.peerjs.com">0</option>
        <option value="1.peerjs.com">1</option>
        <option value="2.peerjs.com">2</option>
      </select>
    </div>
    <div class="row"><button id="joinBtn" class="btn primary">Войти</button></div>
    <div class="row"><a href="index.html" class="btn">В меню</a></div>
    <div id="joinStatus" class="row" style="opacity:.9"></div>
  </div>
  <div id="game" class="mpPanel" style="display:none">
    <div class="title">Click Battle</div>
    <div class="row">Ты: <b id="userScore">0</b></div>
    <div class="row">Соперник: <b id="hostScore">0</b></div>
    <button id="userClick" class="btn primary">Клик!</button>
    <div id="gameStatus" class="row" style="opacity:.9"></div>
  </div>
  <div id="diag" class="diag"></div>
<script>
(()=>{ 
  const join=document.getElementById('join'), game=document.getElementById('game');
  const codeInput=document.getElementById('code'), serverSel=document.getElementById('server'), joinBtn=document.getElementById('joinBtn'), joinStatus=document.getElementById('joinStatus');
  const userScoreEl=document.getElementById('userScore'), hostScoreEl=document.getElementById('hostScore'), clickBtn=document.getElementById('userClick'), gameStatus=document.getElementById('gameStatus');
  const diag=document.getElementById('diag');
  let conn=null, score={host:0,user:0};
  function log(s){ diag.textContent=(diag.textContent+'\n'+s).trim().slice(-2000) }
  joinBtn.onclick=()=>{
    const code=codeInput.value.trim();
    if(!code){ joinStatus.textContent='Введите код'; return; }
    joinStatus.textContent='Подключение...';
    const peer=new Peer(null,{host:serverSel.value, port:443, secure:true, path:'/peerjs', debug:1});
    peer.on('error', e=>{ joinStatus.textContent='Ошибка: '+e; log('peer err '+e); });
    peer.on('open', id=>{
      conn=peer.connect('hookarena-'+code);
      conn.on('open', ()=>{ join.style.display='none'; game.style.display='block'; gameStatus.textContent='Ожидание старта...'; });
      conn.on('data', d=>{
        if(d.type==='start'){ gameStatus.textContent='Игра началась!'; }
        else if(d.type==='score'){ score=d.score; update(); }
        else if(d.type==='end'){ score=d.score; update(); gameStatus.textContent=d.score.host>=10?'Соперник победил':'Ты победил!'; clickBtn.disabled=true; }
      });
      conn.on('close', ()=>log('conn close'));
      conn.on('error', e=>log('conn err '+e));
    });
  };
  clickBtn.onclick=()=>{ conn?.send({type:'click'}); };
  function update(){ userScoreEl.textContent=score.user; hostScoreEl.textContent=score.host; }
})();
</script>
</body>
</html>
