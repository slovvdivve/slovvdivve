<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hook Arena — Multiplayer (r12, TURN+диагностика)</title>
  <style>
    html, body { height: 100%; margin: 0; background:#0b0f17; }
    #root { height: 100%; display:grid; place-items:center; }
    canvas { image-rendering: pixelated; background:#0b0f17; outline:none; }
    .hint{position:fixed;left:50%;transform:translateX(-50%);top:10px;color:#e2e8f0;font:14px/1.4 system-ui,sans-serif;background:#0f172a;border:1px solid #334155;border-radius:10px;padding:8px 12px;display:none}
    .hud{position:fixed;left:10px;top:10px;color:#e5e7eb;font:14px/1.3 system-ui,sans-serif;opacity:.9;display:none}
    .menuBtn{position:fixed;right:12px;top:12px;background:#1f2937;border:1px solid #334155;color:#e5e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;display:none}
    .menuPanel{position:fixed;right:12px;top:56px;background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:10px;min-width:260px;display:none;z-index:10}
    .tabs{display:flex;border-bottom:1px solid #334155}
    .tab{flex:1;padding:8px 10px;text-align:center;cursor:pointer}
    .tab.active{background:#111827}
    .tabBody{padding:10px 12px;font:14px/1.4 system-ui,sans-serif}
    .skillbar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:none;gap:8px; z-index:5}
    .skill{width:48px;height:48px;background:#1f2937;border:2px solid #334155;border-radius:8px;position:relative;overflow:hidden}
    .skill img{width:100%;height:100%;object-fit:cover;opacity:1}
    .skill.cd img{opacity:0.4}
    .skill .cdtimer{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:16px;text-shadow:0 0 4px #000}
    .pickup{position:fixed;left:50%;top:54px;transform:translateX(-50%);background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:6px 10px; font:14px/1.3 system-ui,sans-serif; display:none; z-index:6}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35); z-index:20}
    .modal .card{background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:14px;padding:18px 20px;min-width:320px;max-width:90vw;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .modal .title{font:22px/1.3 system-ui,sans-serif;margin-bottom:10px}
    .modal .msg{font:14px/1.5 system-ui,sans-serif;opacity:.9;margin-bottom:16px}
    .actions{display:flex;gap:10px;justify-content:center}
    .btn{background:#1f2937;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#1d4ed8}
    .mpPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #334155;border-radius:12px;padding:16px 18px;color:#e5e7eb;min-width:320px;display:none; z-index:15}
    .mpTitle{font:18px/1.3 system-ui,sans-serif;margin-bottom:10px}
    .mpRow{margin:8px 0}
    .inp{width:100%;padding:10px 12px;border:1px solid #334155;border-radius:8px;background:#0f172a;color:#e5e7eb;font-size:18px;letter-spacing:2px;text-align:center}
    .badge{display:inline-block;padding:4px 8px;border:1px solid #334155;border-radius:8px;background:#0f172a;margin-left:8px}
    .mpList{border:1px dashed #334155; border-radius:8px; padding:8px 10px; font:14px system-ui,sans-serif; min-height:60px; white-space:pre-line}
    .home{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:12}
    .homeCard{background:#0b1220cc;border:1px solid #334155;color:#e5e7eb;border-radius:16px;padding:20px 24px;min-width:300px;max-width:90vw;text-align:center;backdrop-filter: blur(6px)}
    .homeTitle{font:30px/1.2 system-ui,sans-serif;margin-bottom:14px}
    .homeRow{margin-top:10px;display:flex;gap:10px;justify-content:center}
    .diag{position:fixed;left:10px;bottom:10px;color:#9ca3af;font:12px/1.3 ui-monospace,monospace;max-width:60vw;white-space:pre-wrap}
  </style>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="root"><canvas id="game" width="960" height="540" tabindex="0"></canvas></div>

  <div id="home" class="home">
    <div class="homeCard">
      <div class="homeTitle">HOOK ARENA</div>
      <div>Выбери режим:</div>
      <div class="homeRow">
        <button class="btn primary" id="homePlay">Играть (бот)</button>
        <button class="btn" id="homeMP">Мультиплеер</button>
      </div>
    </div>
  </div>

  <div class="hint" id="hint">WASD/стрелки — движение • ЛКМ — хук (через 3.5с) • M — меню • R — рестарт</div>
  <div id="pickup" class="pickup"></div>
  <button id="btnMenu" class="menuBtn">Главное меню</button>
  <div class="menuPanel" id="menuPanel">
    <div class="tabs">
      <div data-tab="main" class="tab active">Главная</div>
      <div data-tab="profile" class="tab">Профиль</div>
    </div>
    <div class="tabBody" id="tabMain">Добро пожаловать в Hook Arena!</div>
    <div class="tabBody" id="tabProfile" style="display:none">Профиль игрока (заглушка).</div>
  </div>
  <div class="skillbar" id="skillbar">
    <div class="skill" id="hookSkill">
      <img alt="Hook" src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='48' rx='8' ry='8' fill='%231f2937'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Verdana' font-size='22' fill='%23e5e7eb'>H</text></svg>"/>
      <div class="cdtimer" style="display:none"></div>
    </div>
  </div>
  <div class="hud" id="hud"></div>

  <div id="modal" class="modal">
    <div class="card">
      <div class="title" id="modalTitle">Победа!</div>
      <div class="msg" id="modalMsg">Противник утонул. Красиво сыграно.</div>
      <div class="actions">
        <button class="btn primary" id="btnPlayAgain">Сыграть ещё</button>
        <button class="btn" id="btnGoMain">На главную</button>
      </div>
    </div>
  </div>

  <div id="mpMenu" class="mpPanel">
    <div class="mpTitle">Мультиплеер</div>
    <div class="actions">
      <button class="btn primary" id="btnHost">Создать лобби</button>
      <button class="btn" id="btnJoin">Присоединиться</button>
      <button class="btn" id="btnCloseMp">Назад</button>
    </div>
  </div>

  <div id="mpHost" class="mpPanel">
    <div class="mpTitle">Лобби (host: <b>admin</b>) <span id="roomBadge" class="badge"></span></div>
    <div class="mpRow">Код комнаты: <b id="roomCode">-----</b></div>
    <div class="mpRow">Игроки:</div>
    <div id="hostPlayers" class="mpList">admin (ты)</div>
    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="btnStartMp" disabled>Начать игру</button>
      <button class="btn" id="btnHostBack">Назад</button>
    </div>
    <div id="hostStatus" class="mpRow" style="opacity:.8"></div>
  </div>

  <div id="mpJoin" class="mpPanel">
    <div class="mpTitle">Присоединиться как <b>user</b></div>
    <div class="mpRow">
      <input id="joinCode" class="inp" placeholder="Код комнаты (5 цифр)" maxlength="5"
             type="tel" inputmode="numeric" pattern="\\d{5}" autocomplete="one-time-code" enterkeyhint="go" />
    </div>
    <div class="actions">
      <button class="btn primary" id="btnJoinGo">Присоединиться</button>
      <button class="btn" id="btnJoinBack">Назад</button>
    </div>
    <div id="joinStatus" class="mpRow" style="opacity:.9"></div>
  </div>
  <div id="diag" class="diag"></div>

  <script>
  (()=>{
    const W=960, H=540;
    const MP_ENABLED = (location.protocol==='https:' || location.hostname==='localhost');

    const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
    const home=document.getElementById('home'); const homePlay=document.getElementById('homePlay'); const homeMP=document.getElementById('homeMP');
    const mpMenu=document.getElementById('mpMenu'); const mpHost=document.getElementById('mpHost'); const mpJoin=document.getElementById('mpJoin');
    const btnHost=document.getElementById('btnHost'); const btnJoin=document.getElementById('btnJoin'); const btnCloseMp=document.getElementById('btnCloseMp');
    const btnHostBack=document.getElementById('btnHostBack'); const btnJoinBack=document.getElementById('btnJoinBack');
    const btnStartMp=document.getElementById('btnStartMp'); const hostPlayers=document.getElementById('hostPlayers'); const hostStatus=document.getElementById('hostStatus');
    const roomCodeEl=document.getElementById('roomCode'); const roomBadge=document.getElementById('roomBadge');
    const joinCodeEl=document.getElementById('joinCode'); const btnJoinGo=document.getElementById('btnJoinGo'); const joinStatus=document.getElementById('joinStatus');
    const diag=document.getElementById('diag');

    function show(el, v){ el.style.display=v?'block':'none' }
    function openMpMenu(){ show(mpMenu, true); show(mpHost,false); show(mpJoin,false); }
    function closeMpPanels(){ show(mpMenu,false); show(mpHost,false); show(mpJoin,false); }
    function showHome(v){ home.style.display=v?'flex':'none' }
    showHome(true);

    homePlay.onclick=()=>alert('SP тут опущен ради демо сетевой диагностики r12. MP фикс ниже.');
    homeMP.onclick=()=>{ if(!MP_ENABLED || !window.Peer){ alert('Нужен HTTPS'); return } openMpMenu() };
    btnCloseMp.onclick=closeMpPanels;
    btnHost.onclick=()=>createLobby();
    btnHostBack.onclick=()=>openMpMenu();
    btnJoin.onclick=()=>{ show(mpMenu,false); show(mpJoin,true); joinStatus.textContent=''; setTimeout(()=>{ joinCodeEl.focus({preventScroll:true}); joinCodeEl.select&&joinCodeEl.select();},10) };
    btnJoinBack.onclick=()=>openMpMenu();

    // TURN/STUN config (adds TURN via openrelay.metered.ca)
    const peerOpts = {
      debug: 2,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:global.stun.twilio.com:3478?transport=udp' },
          { urls: ['turn:openrelay.metered.ca:80','turn:openrelay.metered.ca:443','turn:openrelay.metered.ca:443?transport=tcp'],
            username: 'openrelayproject', credential: 'openrelayproject' }
        ]
      }
    };

    let peer=null, conn=null, roomCode=null, connectTO=null;

    function makeRoomCode(){ return String(Math.floor(10000+Math.random()*90000)) }
    function roomIdFromCode(code){ return 'hookarena-'+code }

    function log(s){ diag.textContent = (diag.textContent + '\\n' + s).trim().slice(-1200) }

    function createLobby(){
      openMpMenu(); show(mpHost,true);
      roomCode = makeRoomCode(); roomCodeEl.textContent=roomCode; roomBadge.textContent='код активен, пока ты в лобби';
      try{
        peer = new Peer(roomIdFromCode(roomCode), peerOpts);
        peer.on('open', id => { hostStatus.textContent='Ожидание подключения...'; log('Peer open: '+id) });
        peer.on('error', err => { hostStatus.textContent='Peer error: '+err; log('Peer error: '+err) });
        peer.on('disconnected', ()=>{ log('Peer disconnected') });
        peer.on('close', ()=>{ log('Peer closed') });
        peer.on('connection', c => {
          conn=c; log('Incoming connection');
          hostPlayers.textContent='admin (ты)\\nuser';
          hostStatus.textContent='Игрок подключился.';
          btnStartMp.disabled=false;
          wireConnHost(c);
        });
      }catch(e){ hostStatus.textContent='Peer init failed'; log(e.message||e) }
    }

    btnStartMp.onclick=()=>{
      if(conn && conn.open){ conn.send({t:'start'}); alert('Старт игры! (в r12 геймплей урезан для отладки связи)'); }
      else{ alert('Сначала дождись подключения user') }
    };

    function wireConnHost(c){
      c.on('open', ()=>{ log('Conn open (host)') });
      c.on('error', err=>{ log('Conn error (host): '+err) });
      c.on('close', ()=>{ log('Conn closed (host)') });
      c.on('data', msg=>{ log('Host got: '+JSON.stringify(msg)); });
    }

    btnJoinGo.onclick=()=>{
      const code=(joinCodeEl.value||'').trim();
      if(!/^\\d{5}$/.test(code)){ joinStatus.textContent='Введите 5 цифр.'; return }
      joinStatus.textContent='Подключение...'; log('Join to '+code);
      try{
        peer = new Peer(undefined, peerOpts);
        peer.on('open', id=>{
          log('Peer open (client): '+id);
          const idHost = roomIdFromCode(code);
          conn = peer.connect(idHost, { reliable:true });
          connectTO = setTimeout(()=>{ if(!conn.open){ joinStatus.textContent='Не удалось подключиться (таймаут). Возможно, у хоста симметричный NAT. Попробуйте LTE/Wi‑Fi или VPN.'; log('Timeout waiting for conn.open') } }, 12000);
          wireConnClient(conn);
        });
        peer.on('error', err=>{ joinStatus.textContent='Peer error: '+err; log('Peer error: '+err) });
      }catch(e){ joinStatus.textContent='Peer init failed'; log(e.message||e) }
    };

    function wireConnClient(c){
      c.on('open', ()=>{ clearTimeout(connectTO); joinStatus.textContent='Подключено! Ждём старт от хоста.'; log('Conn open (client)') });
      c.on('error', err=>{ joinStatus.textContent='Conn error: '+err; log('Conn error (client): '+err) });
      c.on('close', ()=>{ joinStatus.textContent='Соединение закрыто'; log('Conn closed (client)') });
      c.on('data', msg=>{ log('Client got: '+JSON.stringify(msg)) });
    }
  })();
  </script>
</body>
</html>
