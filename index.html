<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hook Arena — Multiplayer (r20)</title>
  <style>
    html, body { height: 100%; margin: 0; background:#0b0f17; }
    #root { height: 100%; display:grid; place-items:center; }
    canvas { image-rendering: pixelated; background:#0b0f17; outline:none; }
    .home{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:12}
    .homeCard{background:#0b1220cc;border:1px solid #334155;color:#e5e7eb;border-radius:16px;padding:20px 24px;min-width:300px;max-width:90vw;text-align:center;backdrop-filter: blur(6px)}
    .homeTitle{font:30px/1.2 system-ui,sans-serif;margin-bottom:14px}
    .homeRow{margin-top:10px;display:flex;gap:10px;justify-content:center}
    .btn{background:#1f2937;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#1d4ed8}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .mpPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #334155;border-radius:12px;padding:16px 18px;color:#e5e7eb;min-width:320px;display:none; z-index:15}
    .mpTitle{font:18px/1.3 system-ui,sans-serif;margin-bottom:10px}
    .mpRow{margin:8px 0}
    .badge{display:inline-block;padding:4px 8px;border:1px solid #334155;border-radius:8px;background:#0f172a;margin-left:8px}
    .mpList{border:1px dashed #334155; border-radius:8px; padding:8px 10px; font:14px system-ui,sans-serif; min-height:60px; white-space:pre-line}
    .diag{position:fixed;left:10px;bottom:10px;color:#9ca3af;font:12px/1.3 ui-monospace,monospace;max-width:60vw;white-space:pre-wrap}
  </style>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="root"><canvas id="game" width="960" height="540" tabindex="0"></canvas></div>
  <div id="home" class="home">
    <div class="homeCard">
      <div class="homeTitle">HOOK ARENA</div>
      <div>Выбери режим:</div>
      <div class="homeRow">
        <button class="btn primary" id="homePlay">Играть (бот)</button>
        <button class="btn" id="homeMP">Мультиплеер</button>
      </div>
    </div>
  </div>
  <div id="mpMenu" class="mpPanel">
    <div class="mpTitle">Мультиплеер</div>
    <div class="homeRow">
      <button class="btn primary" id="btnHost">Создать лобби</button>
      <button class="btn" id="btnJoin">Присоединиться</button>
      <button class="btn" id="btnCloseMp">Назад</button>
    </div>
  </div>
  <div id="mpHost" class="mpPanel">
    <div class="mpTitle">Лобби (host: <b>admin</b>) <span id="roomBadge" class="badge"></span></div>
    <div class="mpRow">Код комнаты: <b id="roomCode">-----</b></div>
    <div class="mpRow">Игроки:</div>
    <div id="hostPlayers" class="mpList">admin (ты)</div>
    <div class="homeRow" style="margin-top:10px">
      <button class="btn primary" id="btnStartMp" disabled>Начать игру</button>
      <button class="btn" id="btnHostBack">Назад</button>
    </div>
    <div id="hostStatus" class="mpRow" style="opacity:.9"></div>
  </div>
  <div id="mpJoin" class="mpPanel">
    <div class="mpTitle">Присоединиться как <b>user</b></div>
    <div class="mpRow">
      <input id="joinCode" placeholder="Код комнаты (5 цифр)" maxlength="5"
             type="tel" inputmode="numeric" pattern="\\d{5}" autocomplete="one-time-code" enterkeyhint="go"
             style="width:100%;padding:10px 12px;border:1px solid #334155;border-radius:8px;background:#0f172a;color:#e5e7eb;font-size:20px;letter-spacing:2px;text-align:center" />
    </div>
    <div class="homeRow">
      <button class="btn primary" id="btnJoinGo">Присоединиться</button>
      <button class="btn" id="btnJoinBack">Назад</button>
    </div>
    <div id="joinStatus" class="mpRow" style="opacity:.9"></div>
  </div>
  <div id="diag" class="diag"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const home=document.getElementById('home');
    const mpMenu=document.getElementById('mpMenu'); const mpHost=document.getElementById('mpHost'); const mpJoin=document.getElementById('mpJoin');
    const btnHost=document.getElementById('btnHost'), btnJoin=document.getElementById('btnJoin'), btnCloseMp=document.getElementById('btnCloseMp');
    const roomCodeEl=document.getElementById('roomCode'), roomBadge=document.getElementById('roomBadge');
    const hostPlayers=document.getElementById('hostPlayers'), hostStatus=document.getElementById('hostStatus'), btnStartMp=document.getElementById('btnStartMp'), btnHostBack=document.getElementById('btnHostBack');
    const joinCodeEl=document.getElementById('joinCode'), joinStatus=document.getElementById('joinStatus'), btnJoinBack=document.getElementById('btnJoinBack'), btnJoinGo=document.getElementById('btnJoinGo');
    const diag=document.getElementById('diag');

    const MP_ENABLED=(location.protocol==='https:' || location.hostname==='localhost');
    function openMpMenu(){ mpMenu.style.display='block'; mpHost.style.display='none'; mpJoin.style.display='none' }
    function closeMpPanels(){ mpMenu.style.display='none'; mpHost.style.display='none'; mpJoin.style.display='none' }
    function makeRoomCode(){ return String(Math.floor(10000+Math.random()*90000)) }
    function roomIdFromCode(code){ return 'hookarena-'+code }
    function log(s){ diag.textContent=(diag.textContent+'\\n'+s).trim().slice(-1500) }

    const clouds=['0.peerjs.com','1.peerjs.com','2.peerjs.com'];
    function serverByCode(code){ const s=(code||'').replace(/\\D+/g,''); const sum=[...s].reduce((a,c)=>a+(+c),0); return clouds[sum%clouds.length] }
    function peerOptsFor(host){
      return {
        host, port:443, secure:true, path:'/peerjs',
        debug:1, pingInterval:5000,
        config:{ iceServers:[
          {urls:'stun:stun.l.google.com:19302'},
          {urls:'stun:global.stun.twilio.com:3478'},
          {urls:['turn:openrelay.metered.ca:80','turn:openrelay.metered.ca:443','turn:openrelay.metered.ca:443?transport=tcp'], username:'openrelayproject', credential:'openrelayproject'}
        ]}
      }
    }

    // Home buttons
    document.getElementById('homeMP').onclick=()=>{ if(!MP_ENABLED||!window.Peer){ alert('Мультиплеер доступен по HTTPS/localhost'); return } openMpMenu() };
    document.getElementById('homePlay').onclick=()=> alert('SP игра тут опущена, проверяем MP сеть r20');

    btnCloseMp.onclick=closeMpPanels;
    btnHostBack.onclick=openMpMenu;
    btnJoinBack.onclick=openMpMenu;

    let peer=null, conn=null, roomCode=null, reconTimer=null, peerHost='';

    // ---- Host flow with auto-reconnect ----
    btnHost.onclick=()=>{
      openMpMenu(); mpMenu.style.display='none'; mpHost.style.display='block';
      hostPlayers.textContent='admin (ты)'; hostStatus.textContent='';
      roomCode=makeRoomCode(); peerHost=serverByCode(roomCode); roomCodeEl.textContent=roomCode; roomBadge.textContent='сервер: '+peerHost;
      startPeerAsHost();
    };

    function startPeerAsHost(){
      clearTimeout(reconTimer);
      try{
        peer = new Peer(roomIdFromCode(roomCode), peerOptsFor(peerHost));
        bindPeerHost(peer);
      }catch(e){ hostStatus.textContent='Peer init failed: '+e.message; log(e.message) }
    }
    function bindPeerHost(p){
      p.on('open', id=>{ hostStatus.textContent='Ожидание подключения...'; log('Peer open@'+peerHost+': '+id) });
      p.on('error', err=>{ hostStatus.textContent='Peer error: '+err; log('Peer error: '+err); tryReconnectHost(err) });
      p.on('disconnected', ()=>{ hostStatus.textContent='Потеряна связь с сервером, переподключение...'; log('disconnected'); tryReconnectHost() });
      p.on('close', ()=>{ hostStatus.textContent='Соединение с сервером закрыто, переподключение...'; log('close'); tryReconnectHost() });
      p.on('connection', c=>{ conn=c; log('Incoming conn'); hostPlayers.textContent='admin (ты)\\nuser'; hostStatus.textContent='Игрок подключился.'; btnStartMp.disabled=false; wireConnHost(c) });
    }
    function tryReconnectHost(err){
      clearTimeout(reconTimer);
      reconTimer=setTimeout(()=>{
        log('reconnect...'); try{ peer.destroy() }catch(_){}
        startPeerAsHost();
      }, 1200);
    }
    function wireConnHost(c){
      c.on('open', ()=>log('Conn open (host)'));
      c.on('error', e=>log('Conn error (host): '+e));
      c.on('close', ()=>log('Conn closed (host)'));
      c.on('data', d=>{ if(d&&d.t==='ping'){ c.send({t:'pong'}) } });
    }
    document.getElementById('btnStartMp').onclick=()=>{
      if(conn&&conn.open){ conn.send({t:'start'}); alert('MP стартовал (демо). Игра опущена в r20 — фокус на сети.'); }
    };

    // ---- Join flow with auto host pin ----
    btnJoinGo.onclick=()=>{
      const code=(joinCodeEl.value||'').replace(/\\D+/g,'').slice(0,5);
      if(code.length!==5){ joinStatus.textContent='Введите 5 цифр'; return }
      const host=serverByCode(code); joinStatus.textContent='Подключение... ('+host+')'; log('Join '+code+' @'+host);
      try{
        peer = new Peer(undefined, peerOptsFor(host));
        peer.on('open', id=>{
          log('Peer open (client)@'+host+': '+id);
          const dest=roomIdFromCode(code);
          conn = peer.connect(dest, {reliable:true});
          const to=setTimeout(()=>{ if(!conn.open){ joinStatus.textContent='Не удалось подключиться (таймаут). Проверь, что хост в лобби.'; log('timeout waiting conn.open') } }, 15000);
          conn.on('open', ()=>{ clearTimeout(to); joinStatus.textContent='Подключено! Ждём старт.'; wireConnClient(conn) });
          conn.on('error', e=>{ joinStatus.textContent='Conn error: '+e; log('Conn error: '+e) });
          conn.on('close', ()=>{ joinStatus.textContent='Соединение закрыто'; log('Conn closed') });
        });
        peer.on('error', err=>{ joinStatus.textContent='Peer error: '+err; log('Peer error: '+err) });
        peer.on('disconnected', ()=>{ joinStatus.textContent='Потеряна связь с сервером. Повтор...'; log('disconnected'); try{ peer.reconnect() }catch(_){ } });
      }catch(e){ joinStatus.textContent='Peer init failed: '+e.message; log(e.message) }
    };
    function wireConnClient(c){ c.on('data', d=>{ if(d&&d.t==='start'){ alert('Старт матча (демо r20). Сеть ок.'); } if(d&&d.t==='pong'){ /* keepalive ok */ } }); setInterval(()=>{ try{ c.open && c.send({t:'ping'}) }catch(_){ } }, 8000) }

    // Show mp menu by default for quicker verify
    if(MP_ENABLED) openMpMenu();
  });
  </script>
</body>
</html>
