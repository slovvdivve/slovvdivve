<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>EdQuest ‚Äî –ï–ì–≠ (v5, –ª–µ–≤–æ–µ –º–µ–Ω—é)</title>
<style>
  :root{
    --fs-12: clamp(12px, 0.78rem + 0.1vw, 14px);
    --fs-14: clamp(14px, 0.85rem + 0.2vw, 16px);
    --fs-16: clamp(16px, 0.9rem + 0.3vw, 18px);
    --fs-18: clamp(18px, 1rem + 0.45vw, 22px);
    --fs-22: clamp(22px, 1.05rem + 0.8vw, 28px);
    --fs-28: clamp(24px, 1.2rem + 1.2vw, 32px);
    --panel:#0f1722; --panel-2:#101b2b; --bg:#0b1117;
    --text:#f3f7ff; --muted:#9db3cf;
    --green:#58CC02; --blue:#1CB0F6; --gold:#FFC715;
    --ok:#00d27a; --bad:#ff6b6b;
    --radius: 12px;
    --sidebar-w: 260px;
    --content-max: 1400px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 800px at 10% -10%, rgba(28,176,246,.08), rgba(0,0,0,0) 40%), var(--bg);
        color: var(--text); -webkit-font-smoothing: antialiased; }
  /* ===== Left sidebar (fixed) ===== */
  .sidebar{
    position: fixed; left:0; top:0; bottom:0; width: var(--sidebar-w);
    background: rgba(15,23,34,.98); border-right:1px solid rgba(255,255,255,.08);
    display:flex; flex-direction:column; padding:16px; gap:12px; z-index:5;
  }
  .brand{ display:flex; align-items:center; gap:10px; font-weight:900; font-size: var(--fs-18); cursor:pointer; padding:8px 6px; border-radius:10px }
  .logo{ width:28px; height:28px; border-radius:8px; background: conic-gradient(from 0deg, var(--green), var(--blue), var(--gold), var(--green)); box-shadow: inset 0 0 20px rgba(255,255,255,.18); }
  nav .tab{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color:var(--muted); font-weight:900; cursor:pointer }
  nav .tab.active{ color:var(--text); background: rgba(255,255,255,.08) }
  .side-stat{ margin-top:auto; display:grid; gap:8px }
  .pill{ background: rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; font-weight:900; font-size: var(--fs-12); cursor:pointer; text-align:center }
  .xp-bar{ width:100%; height:10px; background: rgba(255,255,255,.12); border-radius:999px; overflow:hidden }
  .xp-fill{ height:100%; width:0%; background: linear-gradient(90deg, var(--green), var(--blue)) }
  .coins{ text-align:center; font-weight:900; color:var(--gold) }

  /* ===== Content area ===== */
  .content{ margin-left: var(--sidebar-w); padding:20px; }
  .container{ width:min(var(--content-max), 100%); margin:0 auto; display:grid; gap:16px }
  .panel{ background: var(--panel); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); padding:16px; }
  .title{ font-size: var(--fs-22); font-weight:900; margin-bottom:6px }
  .muted{ color: var(--muted) }
  .btn{ appearance:none; border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:12px 14px; background: linear-gradient(180deg,#1b2740,#0f1a2b); color:var(--text); font-weight:900; cursor:pointer }
  .btn.primary{ background: linear-gradient(180deg,#1f3f26,#0f2a14); border-color: rgba(88,204,2,.6) }
  .btn.block{ width:100% }

  .grid{ display:grid; gap:12px }
  .cols-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
  .cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)) }
  @media (max-width: 1200px){ .cols-2,.cols-3{ grid-template-columns: 1fr } }

  /* Hero */
  .hero{ display:grid; grid-template-columns: 1fr 340px; gap:16px; align-items:center }
  @media (max-width: 1000px){ .hero{ grid-template-columns: 1fr } }
  .hero svg{ width:100%; height:auto; opacity:.9; filter: drop-shadow(0 6px 20px rgba(0,0,0,.35)); }

  /* Play UI: session right on desktop, above on smaller */
  .play-wrap{ display:grid; grid-template-columns: 2fr 1fr; gap:16px }
  @media (max-width: 1200px){ .play-wrap{ grid-template-columns: 1fr } }
  .q-title{ font-size: var(--fs-18); font-weight:900; margin-bottom: 10px }
  .choice{ padding: 14px; border-radius: 12px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg,#121d2d,#0e1725); font-weight:800; cursor:pointer }
  .choice.correct{ outline:2px solid var(--ok) } .choice.wrong{ outline:2px solid var(--bad) }
  .answer-input{ width:100%; padding:14px 16px; border-radius:12px; background:#0f1a2b; border:1px solid rgba(255,255,255,.16); color:var(--text); font-size: var(--fs-16) }
  .order-list{ list-style:none; margin:0; padding:0; display:grid; gap:10px }
  .order-item{ padding:14px; border-radius:12px; background:#0f1a2b; border:1px solid rgba(255,255,255,.16); cursor:grab }
  .order-item.dragging{ opacity:.6 }
  .stat-row{ display:flex; gap:12px; flex-wrap:wrap }
  .stat{ display:flex; align-items:center; gap:10px; background: rgba(255,255,255,.06); border-radius:12px; padding:8px 12px }
  .stat b{ font-size: var(--fs-18) }
  canvas.chart{ width:100%; height: 180px }

  /* Shop */
  .shop-grid{ display:grid; gap:12px; grid-template-columns: repeat(3, minmax(0,1fr)); }
  @media (max-width: 1200px){ .shop-grid{ grid-template-columns: 1fr 1fr } }
  @media (max-width: 700px){ .shop-grid{ grid-template-columns: 1fr } }
  .sticker{ background: var(--panel-2); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; display:grid; gap:8px; text-align:center }
  .sticker .img{ font-size:42px; }
  .price{ font-weight:900; color: var(--gold) }

  /* Toast (centered) */
  .toast{ position: fixed; left:50%; bottom: 60px; transform: translateX(-50%);
          background: rgba(10,16,24,.95); border:1px solid rgba(255,255,255,.12); padding: 12px 14px; border-radius: 10px; display:none; z-index:10 }

  /* Modals */
  .modal{ position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:20 }
  .modal .card{ width:min(520px, 92vw); background: var(--panel); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:16px; box-shadow: 0 12px 32px rgba(0,0,0,.5) }
</style>
</head>
<body>
<!-- Sidebar -->
<aside class="sidebar">
  <div class="brand" id="logo"><div class="logo"></div> EdQuest</div>
  <nav>
    <div class="tab active" data-view="home">üè† –ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" data-view="play">‚ñ∂Ô∏è –ò–≥—Ä–∞</div>
    <div class="tab" data-view="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="tab" data-view="shop">üõç –ú–∞–≥–∞–∑–∏–Ω</div>
    <div class="tab" data-view="referrals">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—ã</div>
  </nav>
  <div class="side-stat">
    <div class="pill" id="levelPill">–£—Ä. <span id="uiLevel">1</span></div>
    <div class="xp-bar"><div class="xp-fill" id="uiXpFill"></div></div>
    <div class="coins">ü™ô <span id="uiCoins">0</span></div>
  </div>
</aside>

<!-- Content -->
<div class="content">
  <div class="container" id="views">
    <!-- HOME -->
    <section class="panel" data-view="home">
      <div class="hero">
        <div>
          <div class="title">–£—á–∏—Å—å –∫–∞–∫ –≤ –∏–≥—Ä–µ</div>
          <p class="muted">–ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, —Ä—É—Å—Å–∫–æ–º—É, —Ñ–∏–∑–∏–∫–µ. –°—Ç—Ä–∏–∫–∏, —É—Ä–æ–≤–Ω–∏ –∏ XP ‚Äî –∑–Ω–∞–∫–æ–º–∞—è –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è, –Ω–æ –±–µ–∑ —à—É–º–Ω–æ–≥–æ UI.</p>
          <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap">
            <button class="btn primary" id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            <button class="btn" data-jump="profile">–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
          </div>
        </div>
        <!-- unobtrusive educational illustration -->
        <svg viewBox="0 0 300 220" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#58CC02" stop-opacity="0.9"/>
            <stop offset="1" stop-color="#1CB0F6" stop-opacity="0.9"/>
          </linearGradient></defs>
          <rect x="10" y="20" width="280" height="160" rx="14" fill="url(#g1)" opacity="0.2"/>
          <g fill="#fff" opacity="0.9">
            <circle cx="60" cy="80" r="22" opacity="0.9"/>
            <rect x="100" y="58" width="160" height="12" rx="6" opacity="0.7"/>
            <rect x="100" y="78" width="120" height="10" rx="5" opacity="0.7"/>
            <rect x="20" y="120" width="240" height="12" rx="6" opacity="0.7"/>
            <rect x="20" y="140" width="200" height="10" rx="5" opacity="0.7"/>
          </g>
          <g fill="#fff">
            <text x="20" y="200" font-size="14" fill="#cfe9ff">a^2 + b^2 = c^2</text>
            <text x="200" y="200" font-size="14" fill="#cfe9ff">F = ma</text>
          </g>
        </svg>
      </div>
    </section>

    <!-- PATH -->
    <section class="panel" data-view="home">
      <div class="title">–¢–≤–æ–π –ø—É—Ç—å</div>
      <div class="grid" id="homePath"></div>
    </section>

    <!-- PLAY: session at right (desktop) / top (mobile) -->
    <section class="play-wrap" data-view="play">
      <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <div class="title">–†–∞—É–Ω–¥ <span id="roundNum">1</span></div>
          <div class="pill" id="subjectPill">–ü—Ä–µ–¥–º–µ—Ç: ‚Äî</div>
        </div>
        <div id="questionArea"></div>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
          <button class="btn" id="skipBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
          <button class="btn" id="finishBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
          <button class="btn" id="nextBtn" disabled>–î–∞–ª—å—à–µ</button>
        </div>
      </div>
      <div class="panel">
        <div class="title">–°–µ—Å—Å–∏—è</div>
        <div class="stat-row">
          <div class="stat"><span class="pill">–¢–æ—á–Ω–æ—Å—Ç—å</span><b id="sessAcc">0%</b></div>
          <div class="stat"><span class="pill">–°–µ—Ä–∏—è</span><b id="sessStreak">0</b></div>
          <div class="stat"><span class="pill">–í—Ä–µ–º—è/–∑–∞–¥–∞–Ω–∏–µ</span><b id="sessTime">0.0—Å</b></div>
          <div class="stat"><span class="pill">–†–µ—à–µ–Ω–æ</span><b id="sessSolved">0</b></div>
        </div>
        <div class="grid" style="margin-top:8px">
          <canvas class="chart" id="chartAcc"></canvas>
          <canvas class="chart" id="chartTime"></canvas>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section class="panel" data-view="profile">
      <div class="title">–ü—Ä–æ—Ñ–∏–ª—å</div>
      <div class="grid cols-3">
        <div class="panel">
          <div class="title">–û–±—â–µ–µ</div>
          <div class="grid">
            <div class="stat"><span class="pill">–£—Ä–æ–≤–µ–Ω—å</span><b id="pfLevel">1</b></div>
            <div class="stat"><span class="pill">–û–ø—ã—Ç</span><b id="pfXp">0 / 100</b></div>
            <div class="stat"><span class="pill">–ú–æ–Ω–µ—Ç—ã</span><b id="pfCoins">0</b></div>
            <div class="stat"><span class="pill">–¢–æ—á–Ω–æ—Å—Ç—å</span><b id="pfAcc">0%</b></div>
            <div class="stat"><span class="pill">–ú–∞–∫—Å. —Å–µ—Ä–∏—è</span><b id="pfMaxStreak">0</b></div>
            <div class="stat"><span class="pill">–†–µ—à–µ–Ω–æ</span><b id="pfSolved">0</b></div>
          </div>
        </div>
        <div class="panel">
          <div class="title">–ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</div>
          <canvas class="chart" id="chartSubjects"></canvas>
        </div>
        <div class="panel">
          <div class="title">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
          <div class="grid" id="pfBadges"></div>
        </div>
      </div>
    </section>

    <!-- SHOP -->
    <section class="panel" data-view="shop">
      <div class="title">–ú–∞–≥–∞–∑–∏–Ω –º–æ–Ω–µ—Ç ‚Äî —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∏</div>
      <p class="muted">–û–±–º–µ–Ω–∏–≤–∞–π –º–æ–Ω–µ—Ç—ã –Ω–∞ –Ω–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤ –∫–∞–∫ –≤ Telegram. –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞–±–æ—Ä –æ—Ç–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ ¬´–í–ª–∞–¥–µ–Ω–∏–µ¬ª.</p>
      <div class="shop-grid" id="shopGrid"></div>
    </section>

    <!-- REFERRALS -->
    <section class="panel" data-view="referrals">
      <div class="title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
      <p class="muted">–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π ‚Äî –ø–æ–ª—É—á–∞–π <b>+50 XP</b> –∏ <b>+20 –º–æ–Ω–µ—Ç</b> –∑–∞ –∫–∞–∂–¥–æ–≥–æ.</p>
      <p>–¢–≤–æ–π –∫–æ–¥: <span class="pill" id="refCode">‚Äî</span></p>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0">
        <button class="btn" id="copyCodeBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" id="simulateInviteBtn">–°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
      </div>
      <div class="stat-row">
        <div class="stat"><span class="pill">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</span><b id="refCount">0</b></div>
        <div class="stat"><span class="pill">XP –±–æ–Ω—É—Å</span><b id="refXp">0</b></div>
        <div class="stat"><span class="pill">–ú–æ–Ω–µ—Ç—ã</span><b id="refCoins">0</b></div>
      </div>
      <div style="height:8px"></div>
      <div class="title">–ï—Å—Ç—å –∫–æ–¥ –¥—Ä—É–≥–∞?</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <input id="friendCode" class="answer-input" placeholder="–í–≤–µ–¥–∏ –∫–æ–¥ –¥—Ä—É–≥–∞ ‚Äî +10 –º–æ–Ω–µ—Ç">
        <button class="btn" id="activateFriendCode">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <p class="muted">* –î–µ–º–æ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
    </section>

  </div>
</div>

<!-- Level Modal -->
<div class="modal" id="levelModal">
  <div class="card">
    <div class="title">–¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –∏ –Ω–∞–≥—Ä–∞–¥—ã</div>
    <p class="muted">–ó–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤—ã–¥–∞—é—Ç—Å—è –º–æ–Ω–µ—Ç—ã –∏ —Å—Ç–∏–∫–µ—Ä—ã. –í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è, –¥–µ—Ä–∂–∏ —Å–µ—Ä–∏—é ‚Äî –∏ —Ä–∞—Å—Ç—ë—à—å –±—ã—Å—Ç—Ä–µ–µ.</p>
    <div class="grid">
      <div class="stat-row">
        <div class="stat"><span class="pill">–£—Ä–æ–≤–µ–Ω—å</span><b id="lvNow">1</b></div>
        <div class="stat"><span class="pill">–ü—Ä–æ–≥—Ä–µ—Å—Å</span><b id="lvXp">0 / 100</b></div>
      </div>
      <canvas class="chart" id="chartLevels"></canvas>
    </div>
    <div style="display:flex; justify-content:flex-end; margin-top:10px">
      <button class="btn" id="closeLevelModal">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Post-Session Summary Modal -->
<div class="modal" id="summaryModal">
  <div class="card">
    <div class="title">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>
    <div class="grid">
      <div class="stat-row">
        <div class="stat"><span class="pill">–†–µ—à–µ–Ω–æ</span><b id="sumSolved">0</b></div>
        <div class="stat"><span class="pill">–¢–æ—á–Ω–æ—Å—Ç—å</span><b id="sumAcc">0%</b></div>
        <div class="stat"><span class="pill">–°–µ—Ä–∏—è –º–∞–∫—Å</span><b id="sumStreak">0</b></div>
        <div class="stat"><span class="pill">XP –∑–∞ —Å–µ—Å—Å–∏—é</span><b id="sumXp">0</b></div>
      </div>
      <canvas class="chart" id="sumSubjects"></canvas>
      <canvas class="chart" id="sumTime"></canvas>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" id="sumToHome">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        <button class="btn primary" id="sumRestart">–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Save/State ===== */
const DB_KEY = 'edquest.save.v5';
const Save = { load(){ try{return JSON.parse(localStorage.getItem(DB_KEY))||null}catch(e){return null} },
               save(s){ localStorage.setItem(DB_KEY, JSON.stringify(s)) } };
const initState = ()=>({
  profile:{ level:1, xp:0, xpHist:[], coins:0, maxStreak:0, solved:0, acc:0 },
  session:{ round:0, correct:0, total:0, streak:0, times:[], accHist:[], xpGain:0, subjects:{math:0,russian:0,physics:0} },
  subjects:{ math:{correct:0,total:0}, russian:{correct:0,total:0}, physics:{correct:0,total:0} },
  badges:[],
  referrals:{ code: genCode(), count:0, xp:0, coins:0, usedCodes:[] },
  shop:{ owned:[] }
});
let state = Save.load() || initState();
function genCode(){ return Math.random().toString(36).slice(2,7).toUpperCase(); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none', 2200); }

/* ===== Navigation ===== */
function setActive(view){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.view===view));
  document.querySelectorAll('[data-view]').forEach(s=> s.style.display = (s.dataset.view===view?'block':'none'));
  if(view==='profile') renderProfile();
  if(view==='referrals') renderReferrals();
  if(view==='home') { renderHome(); buildPath(); }
  if(view==='shop') renderShop();
}
document.getElementById('logo').addEventListener('click', ()=> setActive('home')); // logo -> home
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=> setActive(t.dataset.view)));
document.querySelectorAll('[data-jump]').forEach(b=> b.addEventListener('click', ()=> setActive(b.dataset.jump)));
setActive('home');

/* ===== Level modal ===== */
const levelModal = document.getElementById('levelModal');
document.getElementById('levelPill').addEventListener('click', ()=>{ openLevelModal(); });
document.getElementById('closeLevelModal').addEventListener('click', ()=> levelModal.style.display='none');
levelModal.addEventListener('click', (e)=>{ if(e.target===levelModal) levelModal.style.display='none' });
function openLevelModal(){
  levelModal.style.display='flex';
  document.getElementById('lvNow').textContent = state.profile.level;
  const need = 100 + (state.profile.level-1)*50;
  document.getElementById('lvXp').textContent = Math.floor(state.profile.xp)+' / '+need;
  drawLine('chartLevels', state.profile.xpHist.slice(-20).map(v=>v.pct), '–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω–µ–π %');
}

/* ===== Home path ===== */
function buildPath(){
  const root = document.getElementById('homePath'); root.innerHTML = '';
  const subjects = [{id:'math', name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', icon:'‚ûó'},{id:'russian', name:'–†—É—Å—Å–∫–∏–π', icon:'üá∑üá∫'},{id:'physics', name:'–§–∏–∑–∏–∫–∞', icon:'‚öõÔ∏è'}];
  const totalShown = 9;
  for(let i=0;i<totalShown;i++){
    const s = subjects[i%subjects.length];
    const div = document.createElement('div'); div.className='panel';
    div.innerHTML = `<div style="display:flex; align-items:center; gap:12px;">
      <div class="pill">${s.icon}</div>
      <div style="flex:1"><div style="font-weight:900">${s.name} ‚Äî –£—Ä–æ–∫ ${i+1}</div><div class="muted">–ù–∞–≥—Ä–∞–¥–∞: ${8+i%4} XP</div></div>
      <button class="btn">–ü—Ä–æ–π—Ç–∏</button></div>`;
    div.querySelector('.btn').addEventListener('click', ()=> setActive('play'));
    root.appendChild(div);
  }
}

/* ===== Questions: 30 per subject ===== */
const QUESTIONS = buildQuestions();
function buildQuestions(){
  const arr=[];
  function pushMath(i){
    const mod=i%3;
    if(mod===0) arr.push({id:`m${i}`,subject:'math',type:'mcq',text:`(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é: f(x)=${i+1}x^2`,choices:['2x','2(x+1)','x^2','x'],answer:0,xp:10});
    if(mod===1) arr.push({id:`m${i}`,subject:'math',type:'input',text:`(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –†–µ—à–∏: ${i+1}x - ${i} = 0. x = ?`,answer:String((i)/(i+1)),xp:12});
    if(mod===2) arr.push({id:`m${i}`,subject:'math',type:'order',text:'(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –£–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é',items:['-2','0','3','1'],answer:['-2','0','1','3'],xp:12});
  }
  function pushRussian(i){
    const mod=i%3;
    if(mod===0) arr.push({id:`r${i}`,subject:'russian',type:'mcq',text:'–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ —Å –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–π –≥–ª–∞—Å–Ω–æ–π –≤ –∫–æ—Ä–Ω–µ',choices:['–∫...—Å–Ω—É—Ç—å—Å—è','–∑–∞—Ä...—Å–ª–∏','—Ä...—Å—Ç–æ–∫','—Å–∫...–∫–∞—Ç—å'],answer:0,xp:10});
    if(mod===1) arr.push({id:`r${i}`,subject:'russian',type:'input',text:'–í—Å—Ç–∞–≤—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã: –ø—Ä‚Ä¶–∑–∏–¥–µ–Ω—Ç',answer:'–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç',xp:10});
    if(mod===2) arr.push({id:`r${i}`,subject:'russian',type:'order',text:'–°–æ–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',items:['–Ω–∞','–∏–¥—ë—Ç','—É–ª–∏—Ü–µ','–¥–æ–∂–¥—å'],answer:['–Ω–∞','—É–ª–∏—Ü–µ','–∏–¥—ë—Ç','–¥–æ–∂–¥—å'],xp:12});
  }
  function pushPhysics(i){
    const mod=i%3;
    if(mod===0) arr.push({id:`p${i}`,subject:'physics',type:'mcq',text:'–ï–¥–∏–Ω–∏—Ü–∞ —Å–∏–ª—ã –≤ –°–ò:',choices:['–î–∂–æ—É–ª—å','–ü–∞—Å–∫–∞–ª—å','–ù—å—é—Ç–æ–Ω','–í–∞—Ç—Ç'],answer:2,xp:9});
    if(mod===1) arr.push({id:`p${i}`,subject:'physics',type:'input',text:'–°–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞ ~ 3¬∑10^? –º/—Å. –í–≤–µ–¥–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å',answer:'8',xp:11});
    if(mod===2) arr.push({id:`p${i}`,subject:'physics',type:'order',text:'–†–∞—Å–ø–æ–ª–æ–∂–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã',items:['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π','–∑–µ–ª—ë–Ω—ã–π','–∫—Ä–∞—Å–Ω—ã–π'],answer:['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π','–∑–µ–ª—ë–Ω—ã–π','–∫—Ä–∞—Å–Ω—ã–π'],xp:12});
  }
  for(let i=1;i<=30;i++){ pushMath(i); pushRussian(i); pushPhysics(i); }
  return arr;
}
let deck = [];
const buildDeck = ()=> deck = QUESTIONS.slice().sort(()=>Math.random()-.5);

/* ===== Topbar replacement (in sidebar) ===== */
function updateSidebarStats(){
  document.getElementById('uiLevel').textContent = state.profile.level;
  document.getElementById('uiCoins').textContent = state.profile.coins;
  const need = 100 + (state.profile.level-1)*50;
  const fill = Math.max(2, Math.round(state.profile.xp/need*100));
  document.getElementById('uiXpFill').style.width = fill + '%';
}
updateSidebarStats();
function addXP(n){
  state.profile.xp+=n; state.session.xpGain += n;
  let up=false;
  while(state.profile.xp >= (100 + (state.profile.level-1)*50)){
    state.profile.xp -= (100 + (state.profile.level-1)*50);
    state.profile.level++; up=true; state.profile.xpHist.push({ts:Date.now(), pct:100});
    addCoins(20); toast('–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å! +20 –º–æ–Ω–µ—Ç');
  }
  const need = 100 + (state.profile.level-1)*50;
  state.profile.xpHist.push({ts:Date.now(), pct: Math.round(state.profile.xp/need*100)});
  updateSidebarStats(); Save.save(state);
}
function addCoins(n){ state.profile.coins += n; updateSidebarStats(); Save.save(state); }

/* ===== Game flow ===== */
const qArea = document.getElementById('questionArea');
let qStart = 0;
document.getElementById('skipBtn').addEventListener('click', nextQuestion);
document.getElementById('nextBtn').addEventListener('click', nextQuestion);
document.getElementById('startBtn').addEventListener('click', ()=>{ setActive('play'); if(state.session.total===0) startSession(); });
document.getElementById('finishBtn').addEventListener('click', finishSession);

function startSession(){ state.session = { round:0, correct:0, total:0, streak:0, times:[], accHist:[], xpGain:0, subjects:{math:0,russian:0,physics:0} }; buildDeck(); nextQuestion(); }
function nextQuestion(){
  document.getElementById('nextBtn').disabled = true;
  if(deck.length===0) buildDeck();
  const q = deck.shift(); state.session.round++; renderQuestion(q);
}
function renderQuestion(q){
  qStart = performance.now();
  document.getElementById('roundNum').textContent = state.session.round;
  document.getElementById('subjectPill').textContent = '–ü—Ä–µ–¥–º–µ—Ç: ' + ({math:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',russian:'–†—É—Å—Å–∫–∏–π',physics:'–§–∏–∑–∏–∫–∞'}[q.subject]);
  qArea.innerHTML = '';
  const title = document.createElement('div'); title.className='q-title'; title.textContent=q.text; qArea.appendChild(title);
  if(q.type==='mcq'){
    const box = document.createElement('div'); box.className='grid';
    q.choices.forEach((c,i)=>{
      const btn = document.createElement('div'); btn.className='choice'; btn.textContent='‚Ä¢ '+c;
      btn.addEventListener('click', ()=> checkAnswer(q, i===q.answer, btn, ()=> btn.classList.add(i===q.answer?'correct':'wrong')) );
      box.appendChild(btn);
    });
    qArea.appendChild(box);
  } else if(q.type==='input'){
    const input = document.createElement('input'); input.className='answer-input'; input.placeholder='–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç‚Ä¶';
    const b = document.createElement('button'); b.className='btn'; b.textContent='–û—Ç–≤–µ—Ç–∏—Ç—å';
    b.addEventListener('click', ()=>{
      const val = (input.value||'').trim().toLowerCase().replace(',', '.').replace(' ', '');
      const ok = String(q.answer).toLowerCase() === val;
      checkAnswer(q, ok, input, ()=> input.style.outline='2px solid '+(ok?'var(--ok)':'var(--bad)'));
    });
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') b.click(); });
    qArea.appendChild(input); qArea.appendChild(b);
  } else if(q.type==='order'){
    const list = document.createElement('ul'); list.className='order-list';
    q.items.slice().sort(()=>Math.random()-.5).forEach(txt=>{
      const li = document.createElement('li'); li.className='order-item'; li.textContent=txt; li.draggable=true;
      li.addEventListener('dragstart', ()=> li.classList.add('dragging'));
      li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
      list.appendChild(li);
    });
    list.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging=list.querySelector('.dragging'); if(!dragging) return;
      const after = Array.from(list.querySelectorAll('.order-item:not(.dragging)')).find(el=> e.clientY < el.getBoundingClientRect().top + el.offsetHeight/2);
      if(after) list.insertBefore(dragging, after); else list.appendChild(dragging);
    });
    const b = document.createElement('button'); b.className='btn'; b.textContent='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫';
    b.addEventListener('click', ()=>{
      const arr = Array.from(list.children).map(li=>li.textContent);
      const ok = JSON.stringify(arr)===JSON.stringify(q.answer);
      checkAnswer(q, ok, list, ()=> list.style.outline='2px solid '+(ok?'var(--ok)':'var(--bad)'));
    });
    qArea.appendChild(list); qArea.appendChild(b);
  }
}
function checkAnswer(q, ok, el, decorate){
  decorate && decorate();
  const elapsed = (performance.now()-qStart)/1000;
  state.session.total++; state.profile.solved++; state.session.times.push(elapsed);
  if(ok){ state.session.correct++; state.session.streak++; addXP(q.xp); addCoins(1); state.session.subjects[q.subject]++; toast('–í–µ—Ä–Ω–æ! +' + q.xp + ' XP'); }
  else { state.session.streak = 0; }
  state.profile.maxStreak = Math.max(state.profile.maxStreak, state.session.streak);
  state.subjects[q.subject].total++; if(ok) state.subjects[q.subject].correct++;
  const acc = state.session.correct/state.session.total;
  state.session.accHist.push(acc);
  const totalCorrect = state.subjects.math.correct + state.subjects.russian.correct + state.subjects.physics.correct;
  const total = state.subjects.math.total + state.subjects.russian.total + state.subjects.physics.total;
  state.profile.acc = total? (totalCorrect/total) : 0;
  Save.save(state); renderSession(); document.getElementById('nextBtn').disabled = false;
}
function renderSession(){
  const acc = state.session.total? Math.round(state.session.correct/state.session.total*100):0;
  document.getElementById('sessAcc').textContent = acc+'%';
  document.getElementById('sessStreak').textContent = state.session.streak;
  document.getElementById('sessSolved').textContent = state.session.total;
  const t = state.session.times.at(-1)||0;
  document.getElementById('sessTime').textContent = t.toFixed(1)+'—Å';
  drawLine('chartAcc', state.session.accHist.map(v=>Math.round(v*100)), '–¢–æ—á–Ω–æ—Å—Ç—å %');
  drawLine('chartTime', state.session.times, '–í—Ä–µ–º—è (—Å)');
  updateSidebarStats(); buildPath();
}
function finishSession(){
  const solved = state.session.total;
  const acc = solved? Math.round(state.session.correct/solved*100):0;
  document.getElementById('sumSolved').textContent = solved;
  document.getElementById('sumAcc').textContent = acc+'%';
  document.getElementById('sumStreak').textContent = state.profile.maxStreak;
  document.getElementById('sumXp').textContent = state.session.xpGain;
  drawBars('sumSubjects', [['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', state.session.subjects.math], ['–†—É—Å—Å–∫–∏–π', state.session.subjects.russian], ['–§–∏–∑–∏–∫–∞', state.session.subjects.physics]]);
  drawLine('sumTime', state.session.times, '–í—Ä–µ–º—è (—Å)');
  document.getElementById('summaryModal').style.display='flex';
}
document.getElementById('sumToHome').addEventListener('click', ()=>{ document.getElementById('summaryModal').style.display='none'; setActive('home'); });
document.getElementById('sumRestart').addEventListener('click', ()=>{ document.getElementById('summaryModal').style.display='none'; startSession(); });
document.getElementById('summaryModal').addEventListener('click', (e)=>{ if(e.target.id==='summaryModal') e.currentTarget.style.display='none'; });

/* ===== Profile ===== */
function renderProfile(){
  document.getElementById('pfLevel').textContent = state.profile.level;
  const need = 100 + (state.profile.level-1)*50;
  document.getElementById('pfXp').textContent = Math.floor(state.profile.xp)+' / '+need;
  document.getElementById('pfCoins').textContent = state.profile.coins;
  document.getElementById('pfAcc').textContent = Math.round(state.profile.acc*100)+'%';
  document.getElementById('pfMaxStreak').textContent = state.profile.maxStreak;
  document.getElementById('pfSolved').textContent = state.profile.solved;
  const s = state.subjects;
  drawBars('chartSubjects', [['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', pct(s.math)], ['–†—É—Å—Å–∫–∏–π', pct(s.russian)], ['–§–∏–∑–∏–∫–∞', pct(s.physics)]]);
  renderBadges('pfBadges');
}
function pct(x){ return x.total? Math.round(x.correct/x.total*100):0; }
function renderBadges(id){
  const root = document.getElementById(id); if(!root) return; root.innerHTML='';
  if(state.badges.length===0) { root.innerHTML = '<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π ‚Äî —Ä–µ—à–∞–π –∑–∞–¥–∞—á–∏!</div>'; return; }
  for(const b of state.badges){
    const card = document.createElement('div'); card.className='panel'; card.style.textAlign='center';
    card.innerHTML = '<div style="font-size:28px">'+b.icon+'</div><div style="font-weight:900">'+b.name+'</div><div class="muted">'+b.desc+'</div>';
    root.appendChild(card);
  }
}

/* ===== Charts ===== */
function drawLine(id, arr, label){
  const c = document.getElementById(id); const ctx = c.getContext('2d');
  c.width = c.clientWidth * devicePixelRatio; c.height = c.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle='#9db3cf'; ctx.globalAlpha=.8; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(label, 8*devicePixelRatio, 14*devicePixelRatio); ctx.globalAlpha=1;
  if(arr.length<2) return;
  const max=Math.max(...arr, 100), min=Math.min(...arr, 0);
  const pad=10*devicePixelRatio, w=c.width-pad*2, h=c.height-pad*2;
  ctx.beginPath();
  arr.forEach((v,i)=>{ const x=pad + i/(arr.length-1)*w; const y=pad + (1-(v-min)/(max-min))*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.strokeStyle= '#1CB0F6'; ctx.lineWidth= 2*devicePixelRatio; ctx.stroke();
}
function drawBars(id, pairs){
  const c = document.getElementById(id); const ctx = c.getContext('2d');
  c.width = c.clientWidth * devicePixelRatio; c.height = c.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,c.width,c.height);
  const pad=16*devicePixelRatio, bw=(c.width-pad*2)/(pairs.length*1.6);
  const maxVal = Math.max(1, ...pairs.map(p=>p[1]));
  pairs.forEach((p,i)=>{
    const x = pad + i*bw*1.6; const h=(c.height-pad*2)*(p[1]/maxVal);
    ctx.fillStyle = '#58CC02'; ctx.fillRect(x, c.height-pad-h, bw, h);
    ctx.fillStyle = '#9db3cf'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(p[0], x, c.height-4*devicePixelRatio);
  });
}
new ResizeObserver(()=>{ renderSession(); if(document.querySelector('[data-view="profile"]').style.display==='block') renderProfile(); }).observe(document.getElementById('views'));

/* ===== Shop ===== */
const STICKERS = [
  {id:'s1', name:'–£—á—ë–±–∞ ‚Äî –ë–∞–∑–æ–≤—ã–π', icon:'üìò', price:80},
  {id:'s2', name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Äî –ú–µ–º—ã', icon:'‚ûóüòÑ', price:120},
  {id:'s3', name:'–†—É—Å—Å–∫–∏–π ‚Äî –°–º–∞–π–ª—ã', icon:'üá∑üá∫‚ú®', price:100},
  {id:'s4', name:'–§–∏–∑–∏–∫–∞ ‚Äî –ö–æ—Å–º–æ—Å', icon:'‚öõÔ∏èüöÄ', price:150},
  {id:'s5', name:'–ï–ì–≠ ‚Äî –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', icon:'üéìüî•', price:300},
  {id:'s6', name:'–§–∞–Ω ‚Äî –ö–æ—Ç–∏–∫–∏', icon:'üê±', price:90},
];
function renderShop(){
  const root = document.getElementById('shopGrid'); root.innerHTML='';
  for(const s of STICKERS){
    const owned = state.shop.owned.includes(s.id);
    const div = document.createElement('div'); div.className='sticker';
    div.innerHTML = `<div class="img">${s.icon}</div>
      <div style="font-weight:900">${s.name}</div>
      <div class="price">–¶–µ–Ω–∞: ${s.price} ü™ô</div>
      <button class="btn ${owned?'':'primary'}" ${owned?'disabled':''}>${owned?'–í–ª–∞–¥–µ–Ω–∏–µ':'–ö—É–ø–∏—Ç—å'}</button>`;
    div.querySelector('button').addEventListener('click', ()=>{
      if(owned) return;
      if(state.profile.coins < s.price){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç'); return; }
      state.profile.coins -= s.price; state.shop.owned.push(s.id); Save.save(state); renderShop(); updateSidebarStats(); toast('–ö—É–ø–ª–µ–Ω–æ! –°—Ç–∏–∫–µ—Ä–ø–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω.');
    });
    root.appendChild(div);
  }
}

/* ===== Referrals ===== */
function renderReferrals(){
  document.getElementById('refCode').textContent = state.referrals.code;
  document.getElementById('refCount').textContent = state.referrals.count;
  document.getElementById('refXp').textContent = state.referrals.xp;
  document.getElementById('refCoins').textContent = state.referrals.coins;
}
document.getElementById('copyCodeBtn')?.addEventListener('click', async ()=>{ await navigator.clipboard.writeText(state.referrals.code); toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); });
document.getElementById('simulateInviteBtn')?.addEventListener('click', ()=>{
  state.referrals.count++; state.referrals.xp+=50; state.referrals.coins+=20; addXP(50); addCoins(20); Save.save(state); renderReferrals(); toast('+1 –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');
});
document.getElementById('activateFriendCode')?.addEventListener('click', ()=>{
  const code=(document.getElementById('friendCode').value||'').trim().toUpperCase();
  if(!code) return; if(code===state.referrals.code){ toast('–ù–µ–ª—å–∑—è —Å–≤–æ–π –∫–æ–¥ üôÇ'); return; }
  if(state.referrals.usedCodes.includes(code)){ toast('–ö–æ–¥ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'); return; }
  state.referrals.usedCodes.push(code); addCoins(10); Save.save(state); toast('–ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +10 –º–æ–Ω–µ—Ç');
});

/* ===== Init ===== */
renderHome(); buildPath(); renderShop(); updateSidebarStats(); setActive('home');
function renderHome(){ /* could load personalized data later */ }
</script>
</body>
</html>
