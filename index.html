<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>EdQuest ‚Äî –ï–ì–≠ (v9.1.3 ‚Ä¢ zero baseline only)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='26' fill='%2307131c'/><circle cx='64' cy='64' r='44' fill='none' stroke='%230ef' stroke-width='10'/><text x='50%' y='57%' text-anchor='middle' font-size='48' fill='%230ef'>üéì</text></svg>">
<style>
:root{
  --brand-primary: #00E7F0;
  --brand-accent:  #FF4AF2;
  --brand-support: #C7FFE8;
  --brand-warning: #FFC715;
  --brand-danger:  #ff6b88;
  --bg-0:#050a10; --glass:rgba(10,28,43,.52); --line:rgba(0,255,255,.14);
  --text:#e8fbff; --muted:#9ad0df;
  --radius:14px; --space-2:10px; --space-3:16px; --space-4:22px; --sidebar-w:300px; --content-max:1680px; --sticky:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg-0);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.45;overflow-x:hidden}
.bg{position:fixed;inset:0;z-index:-1;background:
  radial-gradient(900px 600px at 10% -10%, rgba(0,240,255,.07), transparent 40%),
  radial-gradient(900px 600px at 90% 110%, rgba(255,74,242,.06), transparent 40%);}
.grid{position:absolute;inset:0;opacity:.35;background:
  linear-gradient(rgba(0,255,255,.12) 1px, transparent 1px) 0 0/ 32px 32px,
  linear-gradient(90deg, rgba(0,255,255,.12) 1px, transparent 1px) 0 0/ 32px 32px}
@media (prefers-reduced-motion:no-preference){ .grid{animation:m 16s linear infinite}@keyframes m{to{transform:translateY(-32px)}} }

/* layout */
.layout{display:grid;grid-template-columns:var(--sidebar-w) 1fr;min-height:100dvh}
.sidebar{position:sticky;top:0;height:100dvh;background:linear-gradient(180deg,rgba(7,19,28,.85),rgba(7,19,28,.75));border-right:1px solid var(--line);backdrop-filter:blur(10px);display:flex;flex-direction:column;padding:var(--space-4);gap:var(--space-3);z-index:6}
.brand{display:flex;align-items:center;gap:12px;font-weight:900;font-size:20px;cursor:pointer;padding:6px 4px;border-radius:12px}
.logo{width:30px;height:30px;border-radius:8px;background:
  radial-gradient(circle at 30% 30%, var(--brand-primary), transparent 60%),
  radial-gradient(circle at 70% 70%, var(--brand-accent), transparent 60%),
  #09131d;border:1px solid var(--line);box-shadow:0 0 14px rgba(0,255,255,.35)}
.nav{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-right:4px}
.nav .item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:var(--muted);font-weight:900;cursor:pointer;border:1px solid transparent}
.nav .item:hover{background:rgba(0,255,255,.05);border-color:var(--line)}
.nav .item[aria-current="page"]{color:var(--text);background:rgba(0,255,255,.08);border-color:var(--line)}
.nav .item svg{width:22px;height:22px;filter:drop-shadow(0 0 8px rgba(0,255,255,.3))}
.side-stat{margin-top:auto;display:grid;gap:8px}
.stat-chip{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:var(--glass);border:1px solid var(--line)}
.xp-bar{width:100%;height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
.xp-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--brand-primary),var(--brand-accent))}
.footer-mini{font-size:12px;color:var(--muted);text-align:center}

@media (max-width:900px){
  .layout{grid-template-columns:1fr}
  .sidebar{display:none}
}

.content{padding:var(--space-4)}
.container{width:min(var(--content-max),100%);margin:0 auto;display:grid;gap:var(--space-4);padding-inline:var(--space-4)}
@media (max-width:900px){
  .container{padding-inline:16px}
  .panel{max-width:680px;margin-inline:auto;padding:18px}
}

.panel{background:var(--glass);border:1px solid var(--line);border-radius:var(--radius);padding:var(--space-4);backdrop-filter:blur(10px);position:relative;overflow:hidden;height:auto}
.panel:before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(255,255,255,.02),rgba(255,255,255,.02) 1px,transparent 2px);opacity:.4;mix-blend-mode:overlay;pointer-events:none}
.title{font-size:clamp(20px,1.2rem + .5vw,30px);font-weight:900;margin:0 0 10px}
.muted{color:var(--muted)}
.btn{appearance:none;border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:linear-gradient(180deg,#0b1c2c,#07131c);color:var(--text);font-weight:900;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#0b2f3f,#0a1e2a);box-shadow:0 0 10px rgba(0,255,255,.25) inset}
.gridgap{display:grid;gap:10px}

/* play layout */
.play-wrap{display:grid;grid-template-columns:2fr 1fr;gap:24px;align-items:start}
@media (max-width:1200px){ .play-wrap{grid-template-columns:1fr} }
.session-sticky{position:sticky;top:var(--sticky);align-self:start}

/* answers */
.choice{padding:14px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(8,20,32,.8),rgba(6,16,25,.8));font-weight:800;cursor:pointer}
.choice.correct{outline:2px solid var(--brand-support)} .choice.wrong{outline:2px solid var(--brand-danger)}
.answer-input{width:100%;padding:14px 16px;border-radius:12px;background:rgba(6,16,25,.8);border:1px solid var(--line);color:var(--text)}

/* bottom dock (mobile only) */
.dock{position:sticky;bottom:0;z-index:7;background:rgba(7,19,28,.94);border-top:1px solid var(--line);backdrop-filter:blur(8px)}
.dock .row{display:flex;gap:6px;padding:8px}
.dock .item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px;border-radius:10px;color:var(--muted);cursor:pointer;border:1px solid transparent}
.dock .item[aria-current="page"]{color:var(--text);background:rgba(0,255,255,.08);border-color:var(--line)}
.dock .item svg{width:22px;height:22px;display:block;margin-bottom:2px}
@media (min-width:900px){ .dock{display:none} }

/* charts */
canvas.chart{width:100%;height:200px}
@media (max-width:900px){
  canvas.chart{height:120px}
}
</style>
</head>
<body>
<div class="bg"><div class="grid"></div></div>

<div class="layout">
  <aside class="sidebar" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <div class="brand" id="logo" role="button" tabindex="0"><div class="logo"></div> EdQuest</div>
    <nav class="nav" id="sideNav"></nav>
    <div class="side-stat">
      <div class="stat-chip" id="levelPill" tabindex="0">üéì –£—Ä–æ–≤–µ–Ω—å: <b id="uiLevel">1</b></div>
      <div class="xp-bar"><div class="xp-fill" id="uiXpFill"></div></div>
      <div class="stat-chip">ü™ô –ú–æ–Ω–µ—Ç—ã: <b id="uiCoins">0</b></div>
      <div class="footer-mini">¬© EdQuest ‚Ä¢ v9.1.3</div>
    </div>
  </aside>

  <div class="content" id="content">
    <div class="container" id="views">
      <section class="panel" data-view="home">
        <h1 class="title">–ì–ª–∞–≤–Ω–∞—è</h1>
        <p class="muted">–ó–¥–µ—Å—å —Å—Ç–∞—Ä—Ç –∏ –±—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏. –ù–∞–∂–º–∏ ¬´–ù–∞—á–∞—Ç—å –∏–≥—Ä—É¬ª –∏–ª–∏ –≤—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª —Å–ª–µ–≤–∞/–≤–Ω–∏–∑—É.</p>
        <div class="gridgap">
          <button class="btn primary" id="startBtn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <div class="gridgap" id="homePath"></div>
        </div>
      </section>

      <section class="play-wrap" data-view="play">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <h2 class="title" style="margin:0">üéØ –†–∞—É–Ω–¥ <span id="roundNum">1</span></h2>
            <div class="stat-chip">üìö –ü—Ä–µ–¥–º–µ—Ç <b id="subjectPill">‚Äî</b></div>
          </div>
          <div id="questionArea"></div>
          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="btn" id="skipBtn">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn" id="nextBtn" disabled>‚û°Ô∏è –î–∞–ª—å—à–µ</button>
            <button class="btn" id="finishBtn">üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
          </div>
        </div>
        <div class="panel session-sticky">
          <div class="title">üìä –°–µ—Å—Å–∏—è</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="stat-chip">üéØ –¢–æ—á–Ω–æ—Å—Ç—å <b id="sessAcc">0%</b></div>
            <div class="stat-chip">üî• –°–µ—Ä–∏—è <b id="sessStreak">0</b></div>
            <div class="stat-chip">‚è± –í—Ä–µ–º—è/–∑–∞–¥–∞–Ω–∏–µ <b id="sessTime">0.0—Å</b></div>
            <div class="stat-chip">‚úÖ –†–µ—à–µ–Ω–æ <b id="sessSolved">0</b></div>
          </div>
          <div class="gridgap" style="margin-top:8px">
            <canvas class="chart" id="chartAcc"></canvas>
            <canvas class="chart" id="chartTime"></canvas>
          </div>
        </div>
      </section>

      <section class="panel" data-view="profile">
        <div class="title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div class="stat-chip">üéì –£—Ä–æ–≤–µ–Ω—å <b id="pfLevel">1</b></div>
          <div class="stat-chip">‚≠ê –û–ø—ã—Ç <b id="pfXp">0 / 100</b></div>
          <div class="stat-chip">ü™ô –ú–æ–Ω–µ—Ç—ã <b id="pfCoins">0</b></div>
          <div class="stat-chip">üéØ –¢–æ—á–Ω–æ—Å—Ç—å <b id="pfAcc">0%</b></div>
          <div class="stat-chip">üî• –ú–∞–∫—Å. —Å–µ—Ä–∏—è <b id="pfMaxStreak">0</b></div>
          <div class="stat-chip">‚úÖ –†–µ—à–µ–Ω–æ <b id="pfSolved">0</b></div>
        </div>
        <div class="gridgap" style="margin-top:8px">
          <canvas class="chart" id="chartSubjects"></canvas>
        </div>
      </section>

      <section class="panel" data-view="shop">
        <div class="title">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</div>
        <p class="muted">–û–±–º–µ–Ω–∏–≤–∞–π –º–æ–Ω–µ—Ç—ã –Ω–∞ –Ω–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤.</p>
        <div id="shopGrid" class="gridgap"></div>
      </section>

      <section class="panel" data-view="referrals">
        <div class="title">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
        <p>–¢–≤–æ–π –∫–æ–¥: <span class="stat-chip" id="refCode">‚Äî</span></p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="copyCodeBtn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" id="simulateInviteBtn">‚ûï –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <div class="stat-chip">üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ <b id="refCount">0</b></div>
          <div class="stat-chip">‚≠ê XP –±–æ–Ω—É—Å <b id="refXp">0</b></div>
          <div class="stat-chip">ü™ô –ú–æ–Ω–µ—Ç—ã <b id="refCoins">0</b></div>
        </div>
        <div class="title" style="margin-top:12px">üîë –ö–æ–¥ –¥—Ä—É–≥–∞</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="friendCode" class="answer-input" placeholder="–í–≤–µ–¥–∏ –∫–æ–¥ –¥—Ä—É–≥–∞ ‚Äî +10 –º–æ–Ω–µ—Ç">
          <button class="btn" id="activateFriendCode">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </section>

      <section class="panel" data-view="settings">
        <div class="title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" data-scale="0.9">90%</button>
          <button class="btn" data-scale="1.0">100%</button>
          <button class="btn" data-scale="1.1">110%</button>
          <button class="btn" data-scale="1.2">120%</button>
          <button class="btn" id="testToast">üîî –¢–æ—Å—Ç</button>
        </div>
      </section>

      <section class="panel" data-view="help">
        <div class="title">‚ùì –ü–æ–º–æ—â—å</div>
        <p class="muted">–®–æ—Ä—Ç–∫–∞—Ç—ã: G ‚Äî –≥–ª–∞–≤–Ω–∞—è, I ‚Äî –∏–≥—Ä–∞, P ‚Äî –ø—Ä–æ—Ñ–∏–ª—å, S ‚Äî –º–∞–≥–∞–∑–∏–Ω, R ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª—ã.</p>
      </section>
    </div>
  </div>
</div>

<footer class="dock" aria-label="–ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
  <div class="row" id="dockNav"></div>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite" style="display:none"></div>

<script>
/* ===== Router + Nav builder ===== */
const ROUTES=[
  {id:'home',     label:'–ì–ª–∞–≤–Ω–∞—è',  icon:`<path d="M3 10.5 12 3l9 7.5v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9Z" fill="none" stroke="currentColor" stroke-width="1.8"/>`},
  {id:'play',     label:'–ò–≥—Ä–∞',     icon:`<path d="M8 6v12l10-6-10-6Z" fill="none" stroke="currentColor" stroke-width="1.8"/>`},
  {id:'profile',  label:'–ü—Ä–æ—Ñ–∏–ª—å',  icon:`<circle cx="12" cy="8" r="4" fill="none" stroke="currentColor" stroke-width="1.8"/><path d="M4 21a8 8 0 0 1 16 0" fill="none" stroke="currentColor" stroke-width="1.8"/>`},
  {id:'shop',     label:'–ú–∞–≥–∞–∑–∏–Ω',  icon:`<path d="M3 7h18l-2 12H5L3 7Zm4-4h10l2 4H5l2-4Z" fill="none" stroke="currentColor" stroke-width="1.8"/>`},
  {id:'referrals',label:'–†–µ—Ñ–µ—Ä–∞–ª—ã', icon:`<path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm8 0a4 4 0 1 1 0-8 4 4 0 0 1 0 8ZM3 21c0-3 3-5 5-5s5 2 5 5M11 21c0-3 3-5 5-5s5 2 5 5" fill="none" stroke="currentColor" stroke-width="1.8"/>`},
  {id:'settings', label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', icon:`<path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm7.5-3a7.5 7.5 0 0 1-.1 1l2 1.5-2 3.5-2.3-.7a7.6 7.6 0 0 1-1.6 1l-.3 2.4H11l-.3-2.4a7.6 7.6 0 0 1-1.6-1l-2.3.7-2-3.5L6.8 13a7.5 7.5 0 0 1 0-2L3.8 9.5l2-3.5 2.3.7a7.6 7.6 0 0 1 1.6-1L10.7 3h2.6l.3 2.4a7.6 7.6 0 0 1 1.6 1l2.3-.7 2 3.5L19.4 11c.1.3.1.6.1 1Z" fill="none" stroke="currentColor" stroke-width="1.4"/>`},
  {id:'help',     label:'–ü–æ–º–æ—â—å',   icon:`<path d="M12 19h.01M12 17a5 5 0 1 0-5-5" fill="none" stroke="currentColor" stroke-width="1.8"/>`},
];
function buildNav(){
  const side=document.getElementById('sideNav'); side.innerHTML='';
  for(const r of ROUTES){
    const el=document.createElement('div');
    el.className='item'; el.setAttribute('data-view',r.id); el.innerHTML=`<svg viewBox="0 0 24 24" aria-hidden="true">${r.icon}</svg>${r.label}`;
    el.addEventListener('click', ()=> setActive(r.id));
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); setActive(r.id); } });
    el.tabIndex=0; side.appendChild(el);
  }
  const dock=document.getElementById('dockNav'); dock.innerHTML='';
  for(const r of ROUTES.slice(0,5)){
    const el=document.createElement('div');
    el.className='item'; el.setAttribute('data-view',r.id);
    el.innerHTML=`<svg viewBox="0 0 24 24" aria-hidden="true">${r.icon}</svg><span>${r.label}</span>`;
    el.addEventListener('click', ()=> setActive(r.id));
    el.tabIndex=0; dock.appendChild(el);
  }
}
buildNav();

/* ===== State & helpers ===== */
const DB='edquest.v913'; const Save={load(){try{return JSON.parse(localStorage.getItem(DB))||null}catch(e){return null}},save(s){localStorage.setItem(DB,JSON.stringify(s))}};
const init=()=>({profile:{level:1,xp:0,xpHist:[],coins:0,maxStreak:0,solved:0,acc:0},session:{round:0,correct:0,total:0,streak:0,times:[],accHist:[],xpGain:0,subjects:{math:0,russian:0,physics:0}},subjects:{math:{correct:0,total:0},russian:{correct:0,total:0},physics:{correct:0,total:0}},referrals:{code:code(),count:0,xp:0,coins:0,used:[]},shop:{owned:[]},ui:{scale:1}});
let state=Save.load()||init();
function code(){return Math.random().toString(36).slice(2,7).toUpperCase()}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(toast._t);toast._t=setTimeout(()=>t.style.display='none',2200)}

/* ===== Router ===== */
function setActive(view){
  document.querySelectorAll('[data-view]').forEach(s=>{
    if(s.closest('.container')) s.style.display=(s.dataset.view===view?'block':'none');
  });
  document.querySelectorAll('#sideNav .item').forEach(i=> i.setAttribute('aria-current', i.dataset.view===view ? 'page' : 'false'));
  document.querySelectorAll('#dockNav .item').forEach(i=> i.setAttribute('aria-current', i.dataset.view===view ? 'page' : 'false'));
  if(view==='profile') renderProfile();
  if(view==='referrals') renderRef();
  if(view==='home') { renderHome(); buildPath(); }
  if(view==='shop') renderShop();
  if(view==='play'){ refreshCharts(); }
  document.getElementById('content').scrollTo({top:0,behavior:'smooth'});
}
document.getElementById('logo').addEventListener('click', ()=> setActive('home'));
setActive('home');

/* keyboard shortcuts */
addEventListener('keydown',e=>{
  if(e.target.matches('input,textarea')) return;
  const k=e.key.toLowerCase(); const map={g:'home',i:'play',p:'profile',s:'shop',r:'referrals'};
  if(map[k]) setActive(map[k]);
});

/* UI scale */
document.querySelectorAll('[data-scale]').forEach(b=> b.addEventListener('click', ()=>{ const s=parseFloat(b.dataset.scale||'1'); state.ui.scale=s; document.documentElement.style.fontSize=(16*s)+'px'; Save.save(state); }));
document.documentElement.style.fontSize=(16*(state.ui.scale||1))+'px';

/* Sidebar stats */
function updSide(){ document.getElementById('uiLevel').textContent=state.profile.level; document.getElementById('uiCoins').textContent=state.profile.coins;
  const need=100+(state.profile.level-1)*50; const pct=Math.max(2,Math.round(state.profile.xp/need*100)); document.getElementById('uiXpFill').style.width=pct+'%'; }
updSide();
function addXP(n){ state.profile.xp+=n; state.session.xpGain+=n; while(state.profile.xp>=(100+(state.profile.level-1)*50)){ state.profile.xp-=(100+(state.profile.level-1)*50); state.profile.level++; addCoins(20); } updSide(); Save.save(state) }
function addCoins(n){ state.profile.coins+=n; updSide(); Save.save(state) }

/* Home */
document.getElementById('startBtn').addEventListener('click',()=>{ setActive('play'); if(state.session.total===0) startSession() });
function renderHome(){}
function buildPath(){ const root=document.getElementById('homePath'); root.innerHTML=''; ['üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞','üî§ –†—É—Å—Å–∫–∏–π','üß≤ –§–∏–∑–∏–∫–∞'].forEach((s,i)=>{
  const d=document.createElement('button'); d.className='btn'; d.textContent='‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å: '+s; d.addEventListener('click',()=>setActive('play')); root.appendChild(d);
});}

/* Questions */
const QUESTIONS=(function(){ const arr=[]; const push=(id,subject,type,text,extra)=>arr.push(Object.assign({id,subject,type,text,xp:10},extra||{}));
for(let i=1;i<=30;i++){ const m=i%3; if(m===0) push('m'+i,'math','mcq',`(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é: f(x)=${i+1}x^2`,{choices:['2x','2(x+1)','x^2','x'],answer:0});
if(m===1) push('m'+i,'math','input',`(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –†–µ—à–∏: ${i+1}x - ${i} = 0. x = ?`,{answer:String(i/(i+1))});
if(m===2) push('m'+i,'math','order','(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –£–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é',{items:['-2','0','3','1'],answer:['-2','0','1','3']});
const r=i%3; if(r===0) push('r'+i,'russian','mcq','–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ —Å –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–π –≥–ª–∞—Å–Ω–æ–π –≤ –∫–æ—Ä–Ω–µ',{choices:['–∫...—Å–Ω—É—Ç—å—Å—è','–∑–∞—Ä...—Å–ª–∏','—Ä...—Å—Ç–æ–∫','—Å–∫...–∫–∞—Ç—å'],answer:0});
if(r===1) push('r'+i,'russian','input','–í—Å—Ç–∞–≤—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã: –ø—Ä‚Ä¶–∑–∏–¥–µ–Ω—Ç',{answer:'–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç'});
if(r===2) push('r'+i,'russian','order','–°–æ–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',{items:['–Ω–∞','–∏–¥—ë—Ç','—É–ª–∏—Ü–µ','–¥–æ–∂–¥—å'],answer:['–Ω–∞','—É–ª–∏—Ü–µ','–∏–¥—ë—Ç','–¥–æ–∂–¥—å']});
const p=i%3; if(p===0) push('p'+i,'physics','mcq','–ï–¥–∏–Ω–∏—Ü–∞ —Å–∏–ª—ã –≤ –°–ò:',{choices:['–î–∂–æ—É–ª—å','–ü–∞—Å–∫–∞–ª—å','–ù—å—é—Ç–æ–Ω','–í–∞—Ç—Ç'],answer:2});
if(p===1) push('p'+i,'physics','input','–°–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞ ~ 3¬∑10^? –º/—Å. –í–≤–µ–¥–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å',{answer:'8'});
if(p===2) push('p'+i,'physics','order','–†–∞—Å–ø–æ–ª–æ–∂–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã',{items:['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π','–∑–µ–ª—ë–Ω—ã–π','–∫—Ä–∞—Å–Ω—ã–π'],answer:['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π','–∑–µ–ª—ë–Ω—ã–π','–∫—Ä–∞—Å–Ω—ã–π']}); } return arr; })();
let deck=[]; function buildDeck(){ deck=QUESTIONS.slice().sort(()=>Math.random()-.5) }

const qArea=document.getElementById('questionArea'); let qStart=0;
document.getElementById('skipBtn').addEventListener('click',nextQuestion);
document.getElementById('nextBtn').addEventListener('click',nextQuestion);
document.getElementById('finishBtn').addEventListener('click',finishSession);

function startSession(){ state.session={round:0,correct:0,total:0,streak:0,times:[],accHist:[],xpGain:0,subjects:{math:0,russian:0,physics:0}}; buildDeck(); nextQuestion(); }
function nextQuestion(){ document.getElementById('nextBtn').disabled=true; if(deck.length===0) buildDeck(); const q=deck.shift(); state.session.round++; renderQuestion(q); }
function renderQuestion(q){
  qStart=performance.now();
  document.getElementById('roundNum').textContent=state.session.round;
  document.getElementById('subjectPill').textContent=({math:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',russian:'–†—É—Å—Å–∫–∏–π',physics:'–§–∏–∑–∏–∫–∞'}[q.subject]);
  qArea.innerHTML=''; const t=document.createElement('div'); t.className='title'; t.textContent=q.text; qArea.appendChild(t);
  if(q.type==='mcq'){ const box=document.createElement('div'); box.className='gridgap';
    q.choices.forEach((c,i)=>{ const b=document.createElement('div'); b.className='choice'; b.textContent='‚Ä¢ '+c; b.addEventListener('click',()=>checkAnswer(q,i===q.answer,b,()=>b.classList.add(i===q.answer?'correct':'wrong'))); box.appendChild(b); });
    qArea.appendChild(box);
  } else if(q.type==='input'){ const input=document.createElement('input'); input.className='answer-input'; input.placeholder='–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç‚Ä¶'; const b=document.createElement('button'); b.className='btn'; b.textContent='–û—Ç–≤–µ—Ç–∏—Ç—å';
    b.addEventListener('click',()=>{ const val=(input.value||'').trim().toLowerCase().replace(',', '.').replace(' ', ''); const ok=String(q.answer).toLowerCase()===val; checkAnswer(q,ok,input,()=> input.style.outline='2px solid '+(ok?'#9CF000':'#ff6b88')); });
    input.addEventListener('keydown',e=>{ if(e.key==='Enter') b.click(); }); qArea.appendChild(input); qArea.appendChild(b);
  } else { const list=document.createElement('ul'); list.style.listStyle='none'; list.style.padding='0'; list.className='gridgap';
    q.items.slice().sort(()=>Math.random()-.5).forEach(txt=>{ const li=document.createElement('li'); li.className='choice'; li.textContent=txt; li.draggable=true; li.addEventListener('dragstart',()=>li.classList.add('dragging')); li.addEventListener('dragend',()=>li.classList.remove('dragging')); list.appendChild(li); });
    list.addEventListener('dragover',e=>{ e.preventDefault(); const dragging=list.querySelector('.dragging'); if(!dragging) return; const after=[...list.querySelectorAll('.choice:not(.dragging)')].find(el=> e.clientY < el.getBoundingClientRect().top + el.offsetHeight/2); if(after) list.insertBefore(dragging,after); else list.appendChild(dragging); });
    const b=document.createElement('button'); b.className='btn'; b.textContent='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫'; b.addEventListener('click',()=>{ const arr=[...list.children].map(li=>li.textContent); const ok=JSON.stringify(arr)===JSON.stringify(q.answer); checkAnswer(q,ok,list,()=> list.style.outline='2px solid '+(ok?'#9CF000':'#ff6b88')); });
    qArea.appendChild(list); qArea.appendChild(b);
  }
}
function checkAnswer(q,ok,el,decorate){
  decorate&&decorate(); const elapsed=(performance.now()-qStart)/1000;
  state.session.total++; state.profile.solved++; state.session.times.push(elapsed);
  if(ok){ state.session.correct++; state.session.streak++; addXP(q.xp||10); addCoins(1); state.session.subjects[q.subject]++; toast('–í–µ—Ä–Ω–æ! +' + (q.xp||10) + ' XP'); } else { state.session.streak=0; }
  state.profile.maxStreak=Math.max(state.profile.maxStreak,state.session.streak);
  state.subjects[q.subject].total++; if(ok) state.subjects[q.subject].correct++;
  const acc=state.session.correct/state.session.total; state.session.accHist.push(acc);
  Save.save(state); renderSession(); document.getElementById('nextBtn').disabled=false;
}
function renderSession(){
  const acc=state.session.total? Math.round(state.session.correct/state.session.total*100):0;
  document.getElementById('sessAcc').textContent=acc+'%';
  document.getElementById('sessStreak').textContent=state.session.streak;
  document.getElementById('sessSolved').textContent=state.session.total;
  const t=state.session.times.at(-1)||0; document.getElementById('sessTime').textContent=t.toFixed(1)+'—Å';
  drawLine('chartAcc', state.session.accHist.map(v=>Math.round(v*100)), '–¢–æ—á–Ω–æ—Å—Ç—å %');
  drawLine('chartTime', state.session.times, '–í—Ä–µ–º—è (—Å)');
  updSide();
}
function finishSession(){ toast('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); setActive('home'); }

/* Profile */
function renderProfile(){
  const need=100+(state.profile.level-1)*50;
  document.getElementById('pfLevel').textContent=state.profile.level;
  document.getElementById('pfXp').textContent=Math.floor(state.profile.xp)+' / '+need;
  document.getElementById('pfCoins').textContent=state.profile.coins;
  const total=(state.subjects.math.total+state.subjects.russian.total+state.subjects.physics.total)||1;
  const corr=(state.subjects.math.correct+state.subjects.russian.correct+state.subjects.physics.correct);
  document.getElementById('pfAcc').textContent=Math.round(corr/total*100)+'%';
  document.getElementById('pfMaxStreak').textContent=state.profile.maxStreak;
  document.getElementById('pfSolved').textContent=state.profile.solved;
  drawBars('chartSubjects', [['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', pct(state.subjects.math)], ['–†—É—Å—Å–∫–∏–π', pct(state.subjects.russian)], ['–§–∏–∑–∏–∫–∞', pct(state.subjects.physics)]]);
}
function pct(x){return x.total?Math.round(x.correct/x.total*100):0}

/* Shop */
const STICKERS=[{id:'s1',name:'–£—á—ë–±–∞ ‚Äî –ë–∞–∑–æ–≤—ã–π',icon:'üìò',price:80},{id:'s2',name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Äî –ú–µ–º—ã',icon:'‚ûóüòÑ',price:120},{id:'s3',name:'–†—É—Å—Å–∫–∏–π ‚Äî –°–º–∞–π–ª—ã',icon:'üìù‚ú®',price:100}];
function renderShop(){ const root=document.getElementById('shopGrid'); root.innerHTML=''; for(const s of STICKERS){ const owned=state.shop.owned?.includes(s.id);
  const el=document.createElement('div'); el.className='stat-chip'; el.innerHTML=`<div style="font-size:28px">${s.icon}</div><div style="flex:1"><b>${s.name}</b><div class="muted">–¶–µ–Ω–∞: ${s.price} ü™ô</div></div><button class="btn ${owned?'':'primary'}" ${owned?'disabled':''}>${owned?'‚úÖ –í–ª–∞–¥–µ–Ω–∏–µ':'–ö—É–ø–∏—Ç—å'}</button>`;
  el.querySelector('button').addEventListener('click',()=>{ if(owned) return; if(state.profile.coins<s.price){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç'); return; } state.profile.coins-=s.price; state.shop.owned.push(s.id); Save.save(state); renderShop(); updSide(); toast('–ö—É–ø–ª–µ–Ω–æ!'); });
  root.appendChild(el);
}}

/* Referrals */
function renderRef(){ document.getElementById('refCode').textContent=state.referrals.code;
  document.getElementById('refCount').textContent=state.referrals.count;
  document.getElementById('refXp').textContent=state.referrals.xp;
  document.getElementById('refCoins').textContent=state.referrals.coins; }
document.getElementById('copyCodeBtn')?.addEventListener('click',async()=>{ await navigator.clipboard.writeText(state.referrals.code); toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); });
document.getElementById('simulateInviteBtn')?.addEventListener('click',()=>{ state.referrals.count++; state.referrals.xp+=50; state.referrals.coins+=20; addXP(50); addCoins(20); Save.save(state); renderRef(); toast('+1 –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ'); });
document.getElementById('activateFriendCode')?.addEventListener('click',()=>{ const v=(document.getElementById('friendCode').value||'').trim().toUpperCase(); if(!v) return; if(v===state.referrals.code) return toast('–ù–µ–ª—å–∑—è —Å–≤–æ–π –∫–æ–¥'); if(state.referrals.used?.includes(v)) return toast('–ö–æ–¥ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'); state.referrals.used.push(v); addCoins(10); Save.save(state); toast('–ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω +10'); });

/* Charts ‚Äî LIGHT colors + zero baseline when empty */
function drawLine(id,arr,label){
  const c=document.getElementById(id); if(!c) return; const x=c.getContext('2d');
  c.width=c.clientWidth*devicePixelRatio; c.height=c.clientHeight*devicePixelRatio; x.clearRect(0,0,c.width,c.height);
  const pad=10*devicePixelRatio, w=c.width-pad*2, h=c.height-pad*2;
  x.fillStyle='rgba(230,250,255,.9)'; x.font=(12*devicePixelRatio)+'px system-ui'; x.fillText(label, pad, 14*devicePixelRatio);

  // –†–∏—Å—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ª–∏–Ω–∏—é –Ω–∞ –Ω—É–ª–µ, –µ—Å–ª–∏ —Ç–æ—á–µ–∫ –º–µ–Ω—å—à–µ 2
  if(arr.length < 2){
    const Y = pad + h; // –Ω–æ–ª—å ‚Äî –ø–æ –Ω–∏–∂–Ω–µ–º—É –∫—Ä–∞—é –≥—Ä–∞—Ñ–∏–∫–∞
    x.beginPath(); x.moveTo(pad, Y); x.lineTo(pad + w, Y);
    x.strokeStyle='#B9F3FF'; x.lineWidth=3*devicePixelRatio; x.shadowColor='rgba(185,243,255,.45)'; x.shadowBlur=6*devicePixelRatio; x.stroke();
    return;
  }

  const max=Math.max(...arr,100), min=Math.min(...arr,0);
  x.beginPath();
  arr.forEach((v,i)=>{
    const X=pad+i/(arr.length-1)*w;
    const Y=pad+(1-(v-min)/(max-min))*h;
    if(i===0) x.moveTo(X,Y); else x.lineTo(X,Y);
  });
  x.strokeStyle='#B9F3FF'; x.lineWidth=3*devicePixelRatio; x.shadowColor='rgba(185,243,255,.45)'; x.shadowBlur=6*devicePixelRatio; x.stroke();
}
function drawBars(id,pairs){
  const c=document.getElementById(id); if(!c) return; const x=c.getContext('2d');
  c.width=c.clientWidth*devicePixelRatio; c.height=c.clientHeight*devicePixelRatio; x.clearRect(0,0,c.width,c.height);
  const pad=16*devicePixelRatio,bw=(c.width-pad*2)/(pairs.length*1.6),maxVal=Math.max(1,...pairs.map(p=>p[1]));
  pairs.forEach((p,i)=>{
    const X=pad+i*bw*1.6; const H=(c.height-pad*2)*(p[1]/maxVal);
    x.fillStyle='#C7FFE8'; x.fillRect(X,c.height-pad-H,bw,H);
    x.fillStyle='rgba(230,250,255,.85)'; x.font=(12*devicePixelRatio)+'px system-ui'; x.fillText(p[0],X,c.height-4*devicePixelRatio);
  });
}
function refreshCharts(){ if(document.querySelector('[data-view="play"]').style.display==='block') renderSession(); if(document.querySelector('[data-view="profile"]').style.display==='block') renderProfile(); }
new ResizeObserver(refreshCharts).observe(document.getElementById('views'));

/* Misc */
document.getElementById('testToast')?.addEventListener('click',()=>toast('–≠—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'));

/* Init */
renderHome(); buildPath(); renderShop(); updSide();
</script>
</body>
</html>
