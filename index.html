<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>EdQuest ‚Äî –ï–ì–≠ (v8 ‚Ä¢ Cyber/Neon)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><rect width='128' height='128' rx='26' fill='%2307131c'/><circle cx='64' cy='64' r='44' fill='none' stroke='%230ef' stroke-width='10'/><text x='50%' y='57%' text-anchor='middle' font-size='48' fill='%230ef'>‚ö°</text></svg>">
<style>
/* ====== THEME: CYBER/NEON + GLASS ====== */
:root{
  /* Neon palette */
  --bg-0: #050a10;
  --bg-1: #07131c;  /* glass base */
  --bg-2: #0a1c2b;
  --glass: rgba(10, 28, 43, .55);
  --line: rgba(0, 255, 255, .14);
  --text: #e8fbff;
  --muted: #9ad0df;
  --cyan: #00E7F0;
  --aqua: #00F0FF;
  --mag: #FF4AF2;
  --lime: #9CF000;
  --amber: #FFC715;
  --danger: #ff6b88;
  --ok: #00e79a;
  --blue: #1CB0F6;
  --violet: #7C4DFF;
  --radius: 14px;
  --gap: 16px;
  --sidebar-w: 300px;
  --content-max: 1680px;
  --sticky: 18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:
    radial-gradient(1200px 800px at 10% -10%, rgba(0,240,255,.07), transparent 40%),
    radial-gradient(1200px 800px at 90% 110%, rgba(255,74,242,.06), transparent 40%),
    var(--bg-0);
  color: var(--text);
  -webkit-font-smoothing: antialiased; line-height:1.45;
}
@media (prefers-reduced-motion:no-preference){
  body{ background-attachment: fixed; }
}
/* Neon glow helper */
.glow-cyan{ box-shadow: 0 0 0 1px rgba(0,255,255,.25), 0 0 14px rgba(0,255,255,.25) inset, 0 0 24px rgba(0,255,255,.25) }
.glow-mag{ box-shadow: 0 0 0 1px rgba(255,74,242,.25), 0 0 14px rgba(255,74,242,.25) inset, 0 0 24px rgba(255,74,242,.25) }
.text-glow{ text-shadow: 0 0 8px rgba(0,255,255,.3) }

/* ===== LAYOUT ===== */
.layout{ display:grid; grid-template-columns: var(--sidebar-w) 1fr; min-height:100dvh }
.sidebar{
  position: sticky; top:0; align-self:start; height:100dvh;
  background: linear-gradient(180deg, rgba(7,19,28,.85), rgba(7,19,28,.75));
  border-right: 1px solid var(--line);
  backdrop-filter: blur(10px);
  display:flex; flex-direction:column; padding:18px; gap:12px; z-index:6;
}
.brand{ display:flex; align-items:center; gap:12px; font-weight:900; font-size: 20px; cursor:pointer; padding:10px 8px; border-radius:12px }
.logo{ width:30px; height:30px; border-radius:8px; background:
  radial-gradient(circle at 30% 30%, #0ef, transparent 60%),
  radial-gradient(circle at 70% 70%, #f0f, transparent 60%),
  #09131d; border:1px solid var(--line); box-shadow: 0 0 14px rgba(0,255,255,.35) }
nav{ display:flex; flex-direction:column; gap:10px; overflow:auto; padding-right:4px }
.tab{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--muted); font-weight:900; cursor:pointer; border:1px solid transparent }
.tab:hover{ background: rgba(0,255,255,.05); border-color: var(--line) }
.tab.active{ color:var(--text); background: rgba(0,255,255,.08); border-color: var(--line) }
.tab svg{ width:22px; height:22px; filter: drop-shadow(0 0 8px rgba(0,255,255,.3)); }
.side-stat{ margin-top:auto; display:grid; gap:10px }
.stat-chip{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; background: var(--glass); border:1px solid var(--line) }
.xp-bar{ width:100%; height:10px; background: rgba(255,255,255,.05); border:1px solid var(--line); border-radius:999px; overflow:hidden }
.xp-fill{ height:100%; width:0%; background: linear-gradient(90deg, #0ff, #f0f) }
.footer-mini{ font-size:12px; color: var(--muted); text-align:center }

/* Mobile bottom nav */
.mb{ display:none }
@media (max-width: 900px){
  .layout{ grid-template-columns: 1fr }
  .sidebar{ display:none }
  .mb{ display:block; position: sticky; bottom:0; z-index:7; background: rgba(7,19,28,.9); border-top:1px solid var(--line); backdrop-filter: blur(8px) }
  .mb .row{ display:flex; gap:6px; padding:8px }
  .mb .tab{ flex:1; justify-content:center }
}

/* Content */
.content{ padding:20px }
.container{ width:min(var(--content-max), 100%); margin:0 auto; display:grid; gap: var(--gap) }
.panel{
  background: var(--glass); border:1px solid var(--line); border-radius: var(--radius); padding:16px;
  backdrop-filter: blur(10px); position:relative; overflow:hidden;
}
.panel:before{ /* subtle scanlines */
  content:""; position:absolute; inset:0; background:
    repeating-linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, transparent 2px);
  pointer-events:none; mix-blend-mode: overlay; opacity:.4;
}
.title{ font-size: clamp(20px, 1.2rem + .5vw, 30px); font-weight:900; margin:0 0 8px; display:flex; align-items:center; gap:10px }
.kbd{ font: 600 12px/1 ui-monospace, Menlo, Consolas; background:#08131d; border:1px solid var(--line); padding:2px 6px; border-radius:6px; color:#cfe9ff }
.btn{ appearance:none; border:1px solid var(--line); border-radius:12px; padding:12px 14px; background: linear-gradient(180deg,#0b1c2c,#07131c); color:var(--text); font-weight:900; cursor:pointer }
.btn.primary{ background: linear-gradient(180deg,#0b2f3f,#0a1e2a); box-shadow: 0 0 10px rgba(0,255,255,.25) inset }
.btn.ghost{ background:transparent }
.btn.block{ width:100% }
.btn:active{ transform: translateY(1px) }
.muted{ color: var(--muted) }
.grid{ display:grid; gap:12px }
.cols-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)) }
@media (max-width: 1200px){ .cols-2,.cols-3{ grid-template-columns: 1fr } }

/* HERO */
.hero{ display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:center }
@media (max-width: 1100px){ .hero{ grid-template-columns: 1fr } }
.hero .hud{ border:1px dashed var(--line); border-radius:14px; padding:10px; }
.hero .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background: rgba(0,255,255,.06); border:1px solid var(--line) }

/* PLAY */
.play-wrap{ display:grid; grid-template-columns: 2fr 1fr; gap:var(--gap) }
@media (max-width: 1200px){ .play-wrap{ grid-template-columns: 1fr } }
.session-sticky{ position: sticky; top: var(--sticky); align-self: start }
.breadcrumbs{ display:flex; gap:8px; align-items:center; font-weight:800; color:var(--muted) }
.linklike{ cursor:pointer; text-decoration: underline; text-decoration-style:dotted }
.q-title{ font-size: clamp(18px, 1rem + .4vw, 24px); font-weight:900; margin-bottom: 12px }
.choice{ padding: 14px; border-radius: 12px; border:1px solid var(--line); background: linear-gradient(180deg,rgba(8,20,32,.8),rgba(6,16,25,.8)); font-weight:800; cursor:pointer }
.choice.correct{ outline:2px solid var(--ok); box-shadow: 0 0 12px rgba(0,255,170,.3) inset }
.choice.wrong{ outline:2px solid var(--danger); box-shadow: 0 0 12px rgba(255,80,120,.25) inset }
.answer-input{ width:100%; padding:14px 16px; border-radius:12px; background:rgba(6,16,25,.8); border:1px solid var(--line); color:var(--text); font-size: 16px }
.order-list{ list-style:none; margin:0; padding:0; display:grid; gap:10px }
.order-item{ padding:14px; border-radius:12px; background:rgba(6,16,25,.8); border:1px solid var(--line); cursor:grab }
.order-item.dragging{ opacity:.6 }
.stat-row{ display:flex; gap:10px; flex-wrap:wrap }
.stat{ display:flex; align-items:center; gap:10px; background: rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px; padding:8px 12px }
.stat b{ font-size: clamp(16px, .9rem + .2vw, 20px) }
canvas.chart{ width:100%; height: 220px }

/* SHOP */
.shop-grid{ display:grid; gap:12px; grid-template-columns: repeat(4, minmax(0,1fr)); }
@media (max-width: 1400px){ .shop-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (max-width: 900px){ .shop-grid{ grid-template-columns: 1fr 1fr } }
@media (max-width: 600px){ .shop-grid{ grid-template-columns: 1fr } }
.sticker{ background: rgba(6,16,25,.7); border:1px solid var(--line); border-radius:12px; padding:12px; display:grid; gap:8px; text-align:center }
.sticker .img{ display:flex; align-items:center; justify-content:center; height:64px }
.price{ font-weight:900; color: var(--amber) }

/* TOAST & MODALS */
.toast{ position: fixed; left:50%; bottom: 60px; transform: translateX(-50%);
  background: rgba(7,19,28,.92); border:1px solid var(--line); padding: 12px 14px; border-radius: 10px; display:none; z-index:10; backdrop-filter: blur(8px) }
.modal{ position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:20 }
.modal .card{ width:min(640px, 92vw); background: var(--glass); border:1px solid var(--line); border-radius:14px; padding:16px; backdrop-filter: blur(10px) }

/* 4K optimization: prevent extreme stretching; increase gaps slightly */
@media (min-width: 2560px){
  :root{ --gap: 18px; --sidebar-w: 340px; }
  .content{ padding:28px }
  .panel{ padding:20px }
}
</style>
</head>
<body>
<div class="layout">
  <!-- Sidebar (desktop) -->
  <aside class="sidebar" aria-label="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é">
    <div class="brand" id="logo" role="button" tabindex="0"><div class="logo"></div> <span class="text-glow">EdQuest</span></div>
    <nav id="nav">
      <div class="tab active" data-view="home" tabindex="0">
        <!-- Neon Home icon -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 10.5 12 3l9 7.5v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9Z" fill="none" stroke="#0ff" stroke-width="1.8"/></svg>
        –ì–ª–∞–≤–Ω–∞—è
      </div>
      <div class="tab" data-view="play" tabindex="0">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 6v12l10-6-10-6Z" fill="none" stroke="#0ff" stroke-width="1.8"/></svg>
        –ò–≥—Ä–∞
      </div>
      <div class="tab" data-view="profile" tabindex="0">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" fill="none" stroke="#0ff" stroke-width="1.8"/><path d="M4 21a8 8 0 0 1 16 0" fill="none" stroke="#0ff" stroke-width="1.8"/></svg>
        –ü—Ä–æ—Ñ–∏–ª—å
      </div>
      <div class="tab" data-view="shop" tabindex="0">
        <svg viewBox="0 0 24 24"><path d="M3 7h18l-2 12H5L3 7Zm4-4h10l2 4H5l2-4Z" fill="none" stroke="#0ff" stroke-width="1.8"/></svg>
        –ú–∞–≥–∞–∑–∏–Ω
      </div>
      <div class="tab" data-view="referrals" tabindex="0">
        <svg viewBox="0 0 24 24"><path d="M8 12a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm8 0a4 4 0 1 1 0-8 4 4 0 0 1 0 8ZM3 21c0-3 3-5 5-5s5 2 5 5M11 21c0-3 3-5 5-5s5 2 5 5" fill="none" stroke="#0ff" stroke-width="1.8"/></svg>
        –†–µ—Ñ–µ—Ä–∞–ª—ã
      </div>
      <div class="tab" data-view="settings" tabindex="0">
        <svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm7.5-3a7.5 7.5 0 0 1-.1 1l2 1.5-2 3.5-2.3-.7a7.6 7.6 0 0 1-1.6 1l-.3 2.4H11l-.3-2.4a7.6 7.6 0 0 1-1.6-1l-2.3.7-2-3.5L6.8 13a7.5 7.5 0 0 1 0-2L3.8 9.5l2-3.5 2.3.7a7.6 7.6 0 0 1 1.6-1L10.7 3h2.6l.3 2.4a7.6 7.6 0 0 1 1.6 1l2.3-.7 2 3.5L19.4 11c.1.3.1.6.1 1Z" fill="none" stroke="#0ff" stroke-width="1.4"/></svg>
        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
      </div>
      <div class="tab" data-view="help" tabindex="0">
        <svg viewBox="0 0 24 24"><path d="M12 19h.01M12 17a5 5 0 1 0-5-5" fill="none" stroke="#0ff" stroke-width="1.8"/></svg>
        –ü–æ–º–æ—â—å
      </div>
    </nav>
    <div class="side-stat">
      <div class="stat-chip glow-cyan" id="levelPill" tabindex="0" title="–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è">üéì –£—Ä–æ–≤–µ–Ω—å: <b id="uiLevel">1</b></div>
      <div class="xp-bar"><div class="xp-fill" id="uiXpFill"></div></div>
      <div class="stat-chip">ü™ô –ú–æ–Ω–µ—Ç—ã: <b id="uiCoins">0</b></div>
      <div class="footer-mini">¬© EdQuest ‚Ä¢ v8</div>
    </div>
  </aside>

  <!-- Content -->
  <div class="content" id="content">
    <div class="container" id="views">
      <!-- HOME -->
      <section class="panel glow-cyan" data-view="home">
        <div class="hero">
          <div>
            <h1 class="title text-glow">–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è –≤ –∫–∏–±–µ—Ä‚Äë—Å—Ç–∏–ª–µ</h1>
            <p class="muted">–ó–∞–¥–∞–Ω–∏—è –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, —Ä—É—Å—Å–∫–æ–º—É –∏ —Ñ–∏–∑–∏–∫–µ. –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –ø–∞–Ω–µ–ª–∏, –Ω–µ–æ–Ω–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å ‚Äî –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö –æ—Ç –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–æ 4K.</p>
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); max-width:560px">
              <button class="btn primary" id="startBtn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
              <button class="btn" data-jump="profile">üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>
            <div class="hud" style="margin-top:12px">
              <span class="chip">üí† –ß–∏—Å—Ç—ã–π HUD</span>
              <span class="chip">üß† –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞</span>
              <span class="chip">‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </div>
          </div>
          <!-- HUD illustration (simple neon frame) -->
          <svg viewBox="0 0 320 220" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <g fill="none" stroke="#0ff" stroke-opacity=".7">
              <rect x="6" y="6" width="308" height="208" rx="10" stroke-width="1.5"/>
              <rect x="26" y="26" width="120" height="60" rx="8" stroke-width="1.2"/>
              <rect x="170" y="26" width="120" height="60" rx="8" stroke-width="1.2"/>
              <rect x="26" y="106" width="264" height="88" rx="8" stroke-width="1.2"/>
              <circle cx="280" cy="46" r="10"/>
            </g>
          </svg>
        </div>
      </section>

      <!-- PATH -->
      <section class="panel" data-view="home">
        <div class="title">üß≠ –¢–≤–æ–π –ø—É—Ç—å</div>
        <div class="grid" id="homePath"></div>
      </section>

      <!-- PLAY -->
      <section class="play-wrap" data-view="play">
        <div class="panel glow-cyan">
          <div class="breadcrumbs">
            <span class="linklike" data-jump="home">üè† –ì–ª–∞–≤–Ω–∞—è</span> ‚Ä∫ <b>–ò–≥—Ä–∞</b>
            <span class="chip" style="margin-left:auto">üß† –ü—Ä–∞–∫—Ç–∏–∫–∞</span>
          </div>
          <div style="height:10px"></div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
            <h2 class="title">üéØ –†–∞—É–Ω–¥ <span id="roundNum">1</span></h2>
            <div class="chip" id="subjectPill">üìö –ü—Ä–µ–¥–º–µ—Ç: ‚Äî</div>
          </div>
          <div id="questionArea"></div>
          <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap">
            <button class="btn" id="skipBtn">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="btn" id="finishBtn">üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            <button class="btn" id="nextBtn" disabled>‚û°Ô∏è –î–∞–ª—å—à–µ</button>
          </div>
        </div>
        <div class="panel session-sticky">
          <div class="title">üìä –°–µ—Å—Å–∏—è</div>
          <div class="stat-row">
            <div class="stat">üéØ –¢–æ—á–Ω–æ—Å—Ç—å <b id="sessAcc">0%</b></div>
            <div class="stat">üî• –°–µ—Ä–∏—è <b id="sessStreak">0</b></div>
            <div class="stat">‚è± –í—Ä–µ–º—è/–∑–∞–¥–∞–Ω–∏–µ <b id="sessTime">0.0—Å</b></div>
            <div class="stat">‚úÖ –†–µ—à–µ–Ω–æ <b id="sessSolved">0</b></div>
          </div>
          <div class="grid" style="margin-top:8px">
            <canvas class="chart" id="chartAcc"></canvas>
            <canvas class="chart" id="chartTime"></canvas>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section class="panel" data-view="profile">
        <div class="title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="grid cols-3">
          <div class="panel">
            <div class="title">üìã –û–±—â–µ–µ</div>
            <div class="grid">
              <div class="stat">üéì –£—Ä–æ–≤–µ–Ω—å <b id="pfLevel">1</b></div>
              <div class="stat">‚≠ê –û–ø—ã—Ç <b id="pfXp">0 / 100</b></div>
              <div class="stat">ü™ô –ú–æ–Ω–µ—Ç—ã <b id="pfCoins">0</b></div>
              <div class="stat">üéØ –¢–æ—á–Ω–æ—Å—Ç—å <b id="pfAcc">0%</b></div>
              <div class="stat">üî• –ú–∞–∫—Å. —Å–µ—Ä–∏—è <b id="pfMaxStreak">0</b></div>
              <div class="stat">‚úÖ –†–µ—à–µ–Ω–æ <b id="pfSolved">0</b></div>
            </div>
          </div>
          <div class="panel">
            <div class="title">üß™ –ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</div>
            <canvas class="chart" id="chartSubjects"></canvas>
          </div>
          <div class="panel">
            <div class="title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            <div class="grid" id="pfBadges"></div>
          </div>
        </div>
      </section>

      <!-- SHOP -->
      <section class="panel" data-view="shop">
        <div class="title">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω –º–æ–Ω–µ—Ç ‚Äî —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∏</div>
        <p class="muted">–û–±–º–µ–Ω–∏–≤–∞–π –º–æ–Ω–µ—Ç—ã –Ω–∞ –Ω–∞–±–æ—Ä—ã —Å—Ç–∏–∫–µ—Ä–æ–≤. –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞–±–æ—Ä –æ—Ç–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ ¬´–í–ª–∞–¥–µ–Ω–∏–µ¬ª.</p>
        <div class="shop-grid" id="shopGrid"></div>
      </section>

      <!-- REFERRALS -->
      <section class="panel" data-view="referrals">
        <div class="title">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>
        <p class="muted">–ó–æ–≤–∏ –¥—Ä—É–∑–µ–π ‚Äî –ø–æ–ª—É—á–∞–π <b>+50 XP</b> –∏ <b>+20 –º–æ–Ω–µ—Ç</b> –∑–∞ –∫–∞–∂–¥–æ–≥–æ.</p>
        <p>–¢–≤–æ–π –∫–æ–¥: <span class="stat-chip" id="refCode">‚Äî</span></p>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0">
          <button class="btn" id="copyCodeBtn">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn" id="simulateInviteBtn">‚ûï –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</button>
        </div>
        <div class="stat-row">
          <div class="stat">üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ <b id="refCount">0</b></div>
          <div class="stat">‚≠ê XP –±–æ–Ω—É—Å <b id="refXp">0</b></div>
          <div class="stat">ü™ô –ú–æ–Ω–µ—Ç—ã <b id="refCoins">0</b></div>
        </div>
        <div style="height:8px"></div>
        <div class="title">üîë –ï—Å—Ç—å –∫–æ–¥ –¥—Ä—É–≥–∞?</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="friendCode" class="answer-input" placeholder="–í–≤–µ–¥–∏ –∫–æ–¥ –¥—Ä—É–≥–∞ ‚Äî +10 –º–æ–Ω–µ—Ç">
          <button class="btn" id="activateFriendCode">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <p class="muted">* –î–µ–º–æ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ.</p>
      </section>

      <!-- SETTINGS -->
      <section class="panel" data-view="settings">
        <div class="title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="grid cols-2">
          <div class="panel">
            <div class="title">üéöÔ∏è –ú–∞—Å—à—Ç–∞–± UI</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" data-scale="0.9">90%</button>
              <button class="btn" data-scale="1.0">100%</button>
              <button class="btn" data-scale="1.1">110%</button>
              <button class="btn" data-scale="1.2">120%</button>
            </div>
          </div>
          <div class="panel">
            <div class="title">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
            <button class="btn" id="testToast">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç</button>
          </div>
        </div>
      </section>

      <!-- HELP -->
      <section class="panel" data-view="help">
        <div class="title">‚ùì –ü–æ–º–æ—â—å</div>
        <p class="muted">–®–æ—Ä—Ç–∫–∞—Ç—ã: <span class="kbd">G</span> ‚Äî –≥–ª–∞–≤–Ω–∞—è, <span class="kbd">I</span> ‚Äî –∏–≥—Ä–∞, <span class="kbd">P</span> ‚Äî –ø—Ä–æ—Ñ–∏–ª—å, <span class="kbd">S</span> ‚Äî –º–∞–≥–∞–∑–∏–Ω, <span class="kbd">R</span> ‚Äî —Ä–µ—Ñ–µ—Ä–∞–ª—ã.</p>
        <p class="muted">–í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∫–ª–∏–∫–æ–º –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É —Å–ª–µ–≤–∞.</p>
      </section>
    </div>
  </div>
</div>

<!-- Mobile bottom nav -->
<footer class="mb" aria-label="–ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–º–æ–±–∏–ª—å–Ω–∞—è)">
  <div class="row">
    <div class="tab active" data-view="home">üè†<br>–ì–ª–∞–≤–Ω–∞—è</div>
    <div class="tab" data-view="play">üéÆ<br>–ò–≥—Ä–∞</div>
    <div class="tab" data-view="profile">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="tab" data-view="shop">üõçÔ∏è<br>–ú–∞–≥–∞–∑–∏–Ω</div>
    <div class="tab" data-view="referrals">ü§ù<br>–†–µ—Ñ–µ—Ä–∞–ª—ã</div>
  </div>
</footer>

<!-- Modals -->
<div class="modal" id="levelModal" aria-modal="true" role="dialog">
  <div class="card">
    <div class="title">üéì –¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –∏ –Ω–∞–≥—Ä–∞–¥—ã</div>
    <div class="grid">
      <div class="stat-row">
        <div class="stat">–£—Ä–æ–≤–µ–Ω—å <b id="lvNow">1</b></div>
        <div class="stat">–ü—Ä–æ–≥—Ä–µ—Å—Å <b id="lvXp">0 / 100</b></div>
      </div>
      <canvas class="chart" id="chartLevels"></canvas>
    </div>
    <div style="display:flex; justify-content:flex-end; margin-top:10px">
      <button class="btn" id="closeLevelModal">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal" id="summaryModal" aria-modal="true" role="dialog">
  <div class="card">
    <div class="title">‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</div>
    <div class="grid">
      <div class="stat-row">
        <div class="stat">–†–µ—à–µ–Ω–æ <b id="sumSolved">0</b></div>
        <div class="stat">–¢–æ—á–Ω–æ—Å—Ç—å <b id="sumAcc">0%</b></div>
        <div class="stat">–°–µ—Ä–∏—è –º–∞–∫—Å <b id="sumStreak">0</b></div>
        <div class="stat">XP –∑–∞ —Å–µ—Å—Å–∏—é <b id="sumXp">0</b></div>
      </div>
      <canvas class="chart" id="sumSubjects"></canvas>
      <canvas class="chart" id="sumTime"></canvas>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" id="sumToHome">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        <button class="btn" id="sumRestart">üîÅ –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== State ===== */
const DB_KEY = 'edquest.save.v8';
const Save = { load(){ try{return JSON.parse(localStorage.getItem(DB_KEY))||null}catch(e){return null} },
               save(s){ localStorage.setItem(DB_KEY, JSON.stringify(s)) } };
const initState = ()=>({
  profile:{ level:1, xp:0, xpHist:[], coins:0, maxStreak:0, solved:0, acc:0 },
  session:{ round:0, correct:0, total:0, streak:0, times:[], accHist:[], xpGain:0, subjects:{math:0,russian:0,physics:0} },
  subjects:{ math:{correct:0,total:0}, russian:{correct:0,total:0}, physics:{correct:0,total:0} },
  badges:[],
  referrals:{ code: genCode(), count:0, xp:0, coins:0, usedCodes:[] },
  shop:{ owned:[] },
  ui:{ scale: 1.0 }
});
let state = Save.load() || initState();
function genCode(){ return Math.random().toString(36).slice(2,7).toUpperCase(); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(toast._t); toast._t=setTimeout(()=>t.style.display='none', 2200); }

/* ===== Nav ===== */
function setActive(view){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.view===view));
  document.querySelectorAll('[data-view]').forEach(s=> s.style.display = (s.dataset.view===view?'block':'none'));
  if(view==='profile') renderProfile();
  if(view==='referrals') renderReferrals();
  if(view==='home') { renderHome(); buildPath(); }
  if(view==='shop') renderShop();
  if(view==='play'){ refreshCharts(); }
  document.getElementById('content').scrollTo({top:0, behavior:'smooth'});
}
document.getElementById('logo').addEventListener('click', ()=> setActive('home'));
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=> setActive(t.dataset.view));
  t.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); setActive(t.dataset.view); } });
});
document.querySelectorAll('[data-jump]').forEach(b=> b.addEventListener('click', ()=> setActive(b.dataset.jump)));
setActive('home');

/* Shortcuts */
window.addEventListener('keydown', (e)=>{
  if(e.target.matches('input, textarea')) return;
  const k=e.key.toLowerCase();
  if(k==='g') setActive('home');
  if(k==='i') setActive('play');
  if(k==='p') setActive('profile');
  if(k==='s') setActive('shop');
  if(k==='r') setActive('referrals');
});

/* UI scale */
document.querySelectorAll('[data-scale]').forEach(b=> b.addEventListener('click', ()=>{
  const s=parseFloat(b.dataset.scale||'1'); state.ui.scale=s; document.documentElement.style.fontSize=(16*s)+'px'; Save.save(state);
}));
document.documentElement.style.fontSize=(16*(state.ui.scale||1))+'px';

/* Level modal */
const levelModal = document.getElementById('levelModal');
document.getElementById('levelPill').addEventListener('click', ()=> openLevelModal());
document.getElementById('levelPill').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') openLevelModal(); });
document.getElementById('closeLevelModal').addEventListener('click', ()=> levelModal.style.display='none');
levelModal.addEventListener('click', (e)=>{ if(e.target===levelModal) levelModal.style.display='none' });
function openLevelModal(){
  levelModal.style.display='flex';
  document.getElementById('lvNow').textContent = state.profile.level;
  const need = 100 + (state.profile.level-1)*50;
  document.getElementById('lvXp').textContent = Math.floor(state.profile.xp)+' / '+need;
  drawLine('chartLevels', state.profile.xpHist.slice(-20).map(v=>v.pct), '–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω–µ–π %');
}

/* Home path */
function buildPath(){
  const root = document.getElementById('homePath'); root.innerHTML='';
  const subjects = [{id:'math',name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',icon:'üìê'},{id:'russian',name:'–†—É—Å—Å–∫–∏–π',icon:'üî§'},{id:'physics',name:'–§–∏–∑–∏–∫–∞',icon:'üß≤'}];
  for(let i=1;i<=9;i++){
    const s=subjects[(i-1)%subjects.length];
    const card=document.createElement('div'); card.className='panel'; card.innerHTML=`
      <div style="display:flex; align-items:center; gap:12px">
        <div class="chip">${s.icon}</div>
        <div style="flex:1">
          <div style="font-weight:900">${s.name} ‚Äî –£—Ä–æ–∫ ${i}</div>
          <div class="muted">–ù–∞–≥—Ä–∞–¥–∞: ${8+i%4} XP</div>
        </div>
        <button class="btn">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å</button>
      </div>`;
    card.querySelector('.btn').addEventListener('click', ()=> setActive('play'));
    root.appendChild(card);
  }
}

/* Questions (30 per subject) */
const QUESTIONS = buildQuestions();
function buildQuestions(){
  const arr=[];
  function pushMath(i){
    const mod=i%3;
    if(mod===0) arr.push({id:`m${i}`,subject:'math',type:'mcq',text:`(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é: f(x)=${i+1}x^2`,choices:['2x','2(x+1)','x^2','x'],answer:0,xp:10});
    if(mod===1) arr.push({id:`m${i}`,subject:'math',type:'input',text:`(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –†–µ—à–∏: ${i+1}x - ${i} = 0. x = ?`,answer:String((i)/(i+1)),xp:12});
    if(mod===2) arr.push({id:`m${i}`,subject:'math',type:'order',text:'(–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞) –£–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é',items:['-2','0','3','1'],answer:['-2','0','1','3'],xp:12});
  }
  function pushRussian(i){
    const mod=i%3;
    if(mod===0) arr.push({id:`r${i}`,subject:'russian',type:'mcq',text:'–ù–∞–π–¥–∏—Ç–µ —Å–ª–æ–≤–æ —Å –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–π –≥–ª–∞—Å–Ω–æ–π –≤ –∫–æ—Ä–Ω–µ',choices:['–∫...—Å–Ω—É—Ç—å—Å—è','–∑–∞—Ä...—Å–ª–∏','—Ä...—Å—Ç–æ–∫','—Å–∫...–∫–∞—Ç—å'],answer:0,xp:10});
    if(mod===1) arr.push({id:`r${i}`,subject:'russian',type:'input',text:'–í—Å—Ç–∞–≤—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã: –ø—Ä‚Ä¶–∑–∏–¥–µ–Ω—Ç',answer:'–ø—Ä–µ–∑–∏–¥–µ–Ω—Ç',xp:10});
    if(mod===2) arr.push({id:`r${i}`,subject:'russian',type:'order',text:'–°–æ–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',items:['–Ω–∞','–∏–¥—ë—Ç','—É–ª–∏—Ü–µ','–¥–æ–∂–¥—å'],answer:['–Ω–∞','—É–ª–∏—Ü–µ','–∏–¥—ë—Ç','–¥–æ–∂–¥—å'],xp:12});
  }
  function pushPhysics(i){
    const mod=i%3;
    if(mod===0) arr.push({id:`p${i}`,subject:'physics',type:'mcq',text:'–ï–¥–∏–Ω–∏—Ü–∞ —Å–∏–ª—ã –≤ –°–ò:',choices:['–î–∂–æ—É–ª—å','–ü–∞—Å–∫–∞–ª—å','–ù—å—é—Ç–æ–Ω','–í–∞—Ç—Ç'],answer:2,xp:9});
    if(mod===1) arr.push({id:`p${i}`,subject:'physics',type:'input',text:'–°–∫–æ—Ä–æ—Å—Ç—å —Å–≤–µ—Ç–∞ ~ 3¬∑10^? –º/—Å. –í–≤–µ–¥–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å',answer:'8',xp:11});
    if(mod===2) arr.push({id:`p${i}`,subject:'physics',type:'order',text:'–†–∞—Å–ø–æ–ª–æ–∂–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–ª–∏–Ω—ã –≤–æ–ª–Ω—ã',items:['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π','–∑–µ–ª—ë–Ω—ã–π','–∫—Ä–∞—Å–Ω—ã–π'],answer:['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π','–∑–µ–ª—ë–Ω—ã–π','–∫—Ä–∞—Å–Ω—ã–π'],xp:12});
  }
  for(let i=1;i<=30;i++){ pushMath(i); pushRussian(i); pushPhysics(i); }
  return arr;
}
let deck = []; const buildDeck = ()=> deck = QUESTIONS.slice().sort(()=>Math.random()-.5);

/* Sidebar stats */
function updateSidebarStats(){
  document.getElementById('uiLevel').textContent = state.profile.level;
  document.getElementById('uiCoins').textContent = state.profile.coins;
  const need = 100 + (state.profile.level-1)*50;
  const fill = Math.max(2, Math.round(state.profile.xp/need*100));
  document.getElementById('uiXpFill').style.width = fill + '%';
}
updateSidebarStats();
function addXP(n){
  state.profile.xp+=n; state.session.xpGain += n;
  let up=false;
  while(state.profile.xp >= (100 + (state.profile.level-1)*50)){
    state.profile.xp -= (100 + (state.profile.level-1)*50);
    state.profile.level++; up=true; state.profile.xpHist.push({ts:Date.now(), pct:100});
    addCoins(20); toast('–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å! +20 –º–æ–Ω–µ—Ç üéâ');
  }
  const need = 100 + (state.profile.level-1)*50;
  state.profile.xpHist.push({ts:Date.now(), pct: Math.round(state.profile.xp/need*100)});
  updateSidebarStats(); Save.save(state);
}
function addCoins(n){ state.profile.coins += n; updateSidebarStats(); Save.save(state); }

/* Game flow */
const qArea = document.getElementById('questionArea');
let qStart = 0;
document.getElementById('skipBtn').addEventListener('click', nextQuestion);
document.getElementById('nextBtn').addEventListener('click', nextQuestion);
document.getElementById('startBtn').addEventListener('click', ()=>{ setActive('play'); if(state.session.total===0) startSession(); });
document.querySelectorAll('.breadcrumbs .linklike').forEach(el=> el.addEventListener('click', ()=> setActive('home')));
document.getElementById('finishBtn').addEventListener('click', finishSession);

function startSession(){ state.session = { round:0, correct:0, total:0, streak:0, times:[], accHist:[], xpGain:0, subjects:{math:0,russian:0,physics:0} }; buildDeck(); nextQuestion(); }
function nextQuestion(){
  document.getElementById('nextBtn').disabled = true;
  if(deck.length===0) buildDeck();
  const q = deck.shift(); state.session.round++; renderQuestion(q);
}
function renderQuestion(q){
  qStart = performance.now();
  document.getElementById('roundNum').textContent = state.session.round;
  document.getElementById('subjectPill').textContent = 'üìö –ü—Ä–µ–¥–º–µ—Ç: ' + ({math:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',russian:'–†—É—Å—Å–∫–∏–π',physics:'–§–∏–∑–∏–∫–∞'}[q.subject]);
  qArea.innerHTML = '';
  const title = document.createElement('div'); title.className='q-title'; title.textContent=q.text; qArea.appendChild(title);
  if(q.type==='mcq'){
    const box = document.createElement('div'); box.className='grid';
    q.choices.forEach((c,i)=>{
      const btn = document.createElement('div'); btn.className='choice'; btn.textContent='‚Ä¢ '+c;
      btn.addEventListener('click', ()=> checkAnswer(q, i===q.answer, btn, ()=> btn.classList.add(i===q.answer?'correct':'wrong')) );
      box.appendChild(btn);
    });
    qArea.appendChild(box);
  } else if(q.type==='input'){
    const input = document.createElement('input'); input.className='answer-input'; input.placeholder='–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç‚Ä¶';
    const b = document.createElement('button'); b.className='btn'; b.textContent='–û—Ç–≤–µ—Ç–∏—Ç—å';
    b.addEventListener('click', ()=>{
      const val = (input.value||'').trim().toLowerCase().replace(',', '.').replace(' ', '');
      const ok = String(q.answer).toLowerCase() === val;
      checkAnswer(q, ok, input, ()=> input.style.boxShadow='0 0 12px '+(ok?'rgba(0,255,170,.35)':'rgba(255,80,120,.35)'));
    });
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') b.click(); });
    qArea.appendChild(input); qArea.appendChild(b);
  } else if(q.type==='order'){
    const list = document.createElement('ul'); list.className='order-list';
    q.items.slice().sort(()=>Math.random()-.5).forEach(txt=>{
      const li = document.createElement('li'); li.className='order-item'; li.textContent=txt; li.draggable=true;
      li.addEventListener('dragstart', ()=> li.classList.add('dragging'));
      li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
      list.appendChild(li);
    });
    list.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging=list.querySelector('.dragging'); if(!dragging) return;
      const after = Array.from(list.querySelectorAll('.order-item:not(.dragging)')).find(el=> e.clientY < el.getBoundingClientRect().top + el.offsetHeight/2);
      if(after) list.insertBefore(dragging, after); else list.appendChild(dragging);
    });
    const b = document.createElement('button'); b.className='btn'; b.textContent='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫';
    b.addEventListener('click', ()=>{
      const arr = Array.from(list.children).map(li=>li.textContent);
      const ok = JSON.stringify(arr)===JSON.stringify(q.answer);
      checkAnswer(q, ok, list, ()=> list.style.boxShadow='0 0 12px '+(ok?'rgba(0,255,170,.35)':'rgba(255,80,120,.35)'));
    });
    qArea.appendChild(list); qArea.appendChild(b);
  }
}
function checkAnswer(q, ok, el, decorate){
  decorate && decorate();
  const elapsed = (performance.now()-qStart)/1000;
  state.session.total++; state.profile.solved++; state.session.times.push(elapsed);
  if(ok){ state.session.correct++; state.session.streak++; addXP(q.xp); addCoins(1); state.session.subjects[q.subject]++; toast('–í–µ—Ä–Ω–æ! +' + q.xp + ' XP'); }
  else { state.session.streak = 0; }
  state.profile.maxStreak = Math.max(state.profile.maxStreak, state.session.streak);
  state.subjects[q.subject].total++; if(ok) state.subjects[q.subject].correct++;
  const acc = state.session.correct/state.session.total;
  state.session.accHist.push(acc);
  const totalCorrect = state.subjects.math.correct + state.subjects.russian.correct + state.subjects.physics.correct;
  const total = state.subjects.math.total + state.subjects.russian.total + state.subjects.physics.total;
  state.profile.acc = total? (totalCorrect/total) : 0;
  Save.save(state); renderSession(); document.getElementById('nextBtn').disabled = false;
}
function renderSession(){
  const acc = state.session.total? Math.round(state.session.correct/state.session.total*100):0;
  document.getElementById('sessAcc').textContent = acc+'%';
  document.getElementById('sessStreak').textContent = state.session.streak;
  document.getElementById('sessSolved').textContent = state.session.total;
  const t = state.session.times.at(-1)||0;
  document.getElementById('sessTime').textContent = t.toFixed(1)+'—Å';
  drawLine('chartAcc', state.session.accHist.map(v=>Math.round(v*100)), '–¢–æ—á–Ω–æ—Å—Ç—å %');
  drawLine('chartTime', state.session.times, '–í—Ä–µ–º—è (—Å)');
  updateSidebarStats(); buildPath();
}
function finishSession(){
  const solved = state.session.total;
  const acc = solved? Math.round(state.session.correct/solved*100):0;
  document.getElementById('sumSolved').textContent = solved;
  document.getElementById('sumAcc').textContent = acc+'%';
  document.getElementById('sumStreak').textContent = state.profile.maxStreak;
  document.getElementById('sumXp').textContent = state.session.xpGain;
  drawBars('sumSubjects', [['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', state.session.subjects.math], ['–†—É—Å—Å–∫–∏–π', state.session.subjects.russian], ['–§–∏–∑–∏–∫–∞', state.session.subjects.physics]]);
  drawLine('sumTime', state.session.times, '–í—Ä–µ–º—è (—Å)');
  document.getElementById('summaryModal').style.display='flex';
}
document.getElementById('sumToHome').addEventListener('click', ()=>{ document.getElementById('summaryModal').style.display='none'; setActive('home'); });
document.getElementById('sumRestart').addEventListener('click', ()=>{ document.getElementById('summaryModal').style.display='none'; startSession(); });
document.getElementById('summaryModal').addEventListener('click', (e)=>{ if(e.target.id==='summaryModal') e.currentTarget.style.display='none'; });

/* Profile */
function renderProfile(){
  document.getElementById('pfLevel').textContent = state.profile.level;
  const need = 100 + (state.profile.level-1)*50;
  document.getElementById('pfXp').textContent = Math.floor(state.profile.xp)+' / '+need;
  document.getElementById('pfCoins').textContent = state.profile.coins;
  document.getElementById('pfAcc').textContent = Math.round(state.profile.acc*100)+'%';
  document.getElementById('pfMaxStreak').textContent = state.profile.maxStreak;
  document.getElementById('pfSolved').textContent = state.profile.solved;
  const s = state.subjects;
  drawBars('chartSubjects', [['–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', pct(s.math)], ['–†—É—Å—Å–∫–∏–π', pct(s.russian)], ['–§–∏–∑–∏–∫–∞', pct(s.physics)]]);
  renderBadges('pfBadges');
}
function pct(x){ return x.total? Math.round(x.correct/x.total*100):0; }
function renderBadges(id){
  const root = document.getElementById(id); if(!root) return; root.innerHTML='';
  if(state.badges.length===0) {
    const empty = document.createElement('div');
    empty.className='muted'; empty.textContent='–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π ‚Äî —Ä–µ—à–∞–π –∑–∞–¥–∞—á–∏!';
    root.appendChild(empty);
    return;
  }
  for(const b of state.badges){
    const card = document.createElement('div'); card.className='panel'; card.style.textAlign='center';
    card.innerHTML = '<div style="font-size:28px">'+b.icon+'</div><div style="font-weight:900">'+b.name+'</div><div class="muted">'+b.desc+'</div>';
    root.appendChild(card);
  }
}

/* Charts */
function drawLine(id, arr, label){
  const c = document.getElementById(id); if(!c) return; const ctx = c.getContext('2d');
  c.width = c.clientWidth * devicePixelRatio; c.height = c.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle='#9ad0df'; ctx.globalAlpha=.9; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(label, 8*devicePixelRatio, 14*devicePixelRatio); ctx.globalAlpha=1;
  if(arr.length<2) return;
  const max=Math.max(...arr, 100), min=Math.min(...arr, 0);
  const pad=10*devicePixelRatio, w=c.width-pad*2, h=c.height-pad*2;
  ctx.beginPath();
  arr.forEach((v,i)=>{ const x=pad + i/(arr.length-1)*w; const y=pad + (1-(v-min)/(max-min))*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.strokeStyle= '#00F0FF'; ctx.lineWidth= 2*devicePixelRatio; ctx.stroke();
}
function drawBars(id, pairs){
  const c = document.getElementById(id); if(!c) return; const ctx = c.getContext('2d');
  c.width = c.clientWidth * devicePixelRatio; c.height = c.clientHeight * devicePixelRatio;
  ctx.clearRect(0,0,c.width,c.height);
  const pad=16*devicePixelRatio, bw=(c.width-pad*2)/(pairs.length*1.6);
  const maxVal = Math.max(1, ...pairs.map(p=>p[1]));
  pairs.forEach((p,i)=>{
    const x = pad + i*bw*1.6; const h=(c.height-pad*2)*(p[1]/maxVal);
    ctx.fillStyle = '#9CF000'; ctx.fillRect(x, c.height-pad-h, bw, h);
    ctx.fillStyle = '#9ad0df'; ctx.font=(12*devicePixelRatio)+'px system-ui'; ctx.fillText(p[0], x, c.height-4*devicePixelRatio);
  });
}
function refreshCharts(){
  if(document.querySelector('[data-view="play"]').style.display==='block'){ renderSession(); }
  if(document.querySelector('[data-view="profile"]').style.display==='block'){ renderProfile(); }
}
new ResizeObserver(refreshCharts).observe(document.getElementById('views'));

/* Shop */
const STICKERS = [
  {id:'s1', name:'–£—á—ë–±–∞ ‚Äî –ë–∞–∑–æ–≤—ã–π', icon:'üìò', price:80},
  {id:'s2', name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Äî –ú–µ–º—ã', icon:'‚ûóüòÑ', price:120},
  {id:'s3', name:'–†—É—Å—Å–∫–∏–π ‚Äî –°–º–∞–π–ª—ã', icon:'üìù‚ú®', price:100},
  {id:'s4', name:'–§–∏–∑–∏–∫–∞ ‚Äî –ö–æ—Å–º–æ—Å', icon:'‚öõÔ∏èüöÄ', price:150},
  {id:'s5', name:'–ï–ì–≠ ‚Äî –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', icon:'üéìüî•', price:300},
  {id:'s6', name:'–§–∞–Ω ‚Äî –ö–æ—Ç–∏–∫–∏', icon:'üê±', price:90},
  {id:'s7', name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ ‚Äî –ì–µ–æ', icon:'üìê', price:110},
  {id:'s8', name:'–†—É—Å—Å–∫–∏–π ‚Äî –û—Ä—Ñ–æ', icon:'üî§', price:95},
];
function renderShop(){
  const root = document.getElementById('shopGrid'); root.innerHTML='';
  for(const s of STICKERS){
    const owned = state.shop.owned.includes(s.id);
    const div = document.createElement('div'); div.className='sticker glow-cyan';
    div.innerHTML = `<div class="img"><span style="font-size:46px">${s.icon}</span></div>
      <div style="font-weight:900">${s.name}</div>
      <div class="price">–¶–µ–Ω–∞: ${s.price} ü™ô</div>
      <button class="btn ${owned?'':'primary'}" ${owned?'disabled':''}>${owned?'‚úÖ –í–ª–∞–¥–µ–Ω–∏–µ':'–ö—É–ø–∏—Ç—å'}</button>`;
    div.querySelector('button').addEventListener('click', ()=>{
      if(owned) return;
      if(state.profile.coins < s.price){ toast('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç'); return; }
      state.profile.coins -= s.price; state.shop.owned.push(s.id); Save.save(state); renderShop(); updateSidebarStats(); toast('–ö—É–ø–ª–µ–Ω–æ! –°—Ç–∏–∫–µ—Ä–ø–∞–∫ –¥–æ–±–∞–≤–ª–µ–Ω.');
    });
    root.appendChild(div);
  }
}

/* Referrals */
function renderReferrals(){
  document.getElementById('refCode').textContent = state.referrals.code;
  document.getElementById('refCount').textContent = state.referrals.count;
  document.getElementById('refXp').textContent = state.referrals.xp;
  document.getElementById('refCoins').textContent = state.referrals.coins;
}
document.getElementById('copyCodeBtn')?.addEventListener('click', async ()=>{ await navigator.clipboard.writeText(state.referrals.code); toast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); });
document.getElementById('simulateInviteBtn')?.addEventListener('click', ()=>{
  state.referrals.count++; state.referrals.xp+=50; state.referrals.coins+=20; addXP(50); addCoins(20); Save.save(state); renderReferrals(); toast('+1 –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ');
});
document.getElementById('activateFriendCode')?.addEventListener('click', ()=>{
  const code=(document.getElementById('friendCode').value||'').trim().toUpperCase();
  if(!code) return; if(code===state.referrals.code){ toast('–ù–µ–ª—å–∑—è —Å–≤–æ–π –∫–æ–¥ üôÇ'); return; }
  if(state.referrals.usedCodes.includes(code)){ toast('–ö–æ–¥ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'); return; }
  state.referrals.usedCodes.push(code); addCoins(10); Save.save(state); toast('–ö–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! +10 –º–æ–Ω–µ—Ç');
});

/* Settings */
document.getElementById('testToast').addEventListener('click', ()=> toast('–≠—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ üòé'));

/* Init */
renderHome(); buildPath(); renderShop(); updateSidebarStats(); setActive('home');
function renderHome(){ /* personalize later */ }
</script>
</body>
</html>
