<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hook Arena — GH Pages Multiplayer (r9)</title>
  <style>
    html, body { height: 100%; margin: 0; background:#0b0f17; }
    #root { height: 100%; display:grid; place-items:center; }
    canvas { image-rendering: pixelated; background:#0b0f17; outline:none; }
    .hint{position:fixed;left:50%;transform:translateX(-50%);top:10px;color:#e2e8f0;font:14px/1.4 system-ui,sans-serif;background:#0f172a;border:1px solid #334155;border-radius:10px;padding:8px 12px}
    .hud{position:fixed;left:10px;top:10px;color:#e5e7eb;font:14px/1.3 system-ui,sans-serif;opacity:.9}
    .menuBtn{position:fixed;right:12px;top:12px;background:#1f2937;border:1px solid #334155;color:#e5e7eb;border-radius:8px;padding:8px 12px;cursor:pointer}
    .menuPanel{position:fixed;right:12px;top:56px;background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:10px;min-width:260px;display:none}
    .tabs{display:flex;border-bottom:1px solid #334155}
    .tab{flex:1;padding:8px 10px;text-align:center;cursor:pointer}
    .tab.active{background:#111827}
    .tabBody{padding:10px 12px;font:14px/1.4 system-ui,sans-serif}
    .skillbar{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:8px}
    .skill{width:48px;height:48px;background:#1f2937;border:2px solid #334155;border-radius:8px;position:relative;overflow:hidden}
    .skill img{width:100%;height:100%;object-fit:cover;opacity:1}
    .skill.cd img{opacity:0.4}
    .skill .cdtimer{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:16px;text-shadow:0 0 4px #000}
    .pickup{position:fixed;left:50%;top:54px;transform:translateX(-50%);background:#0f172a; color:#e5e7eb; border:1px solid #334155; border-radius:10px; padding:6px 10px; font:14px/1.3 system-ui,sans-serif; display:none}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
    .modal .card{background:#0b1220;border:1px solid #334155;color:#e5e7eb;border-radius:14px;padding:18px 20px;min-width:320px;max-width:90vw;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .modal .title{font:22px/1.3 system-ui,sans-serif;margin-bottom:10px}
    .modal .msg{font:14px/1.5 system-ui,sans-serif;opacity:.9;margin-bottom:16px}
    .actions{display:flex;gap:10px;justify-content:center}
    .btn{background:#1f2937;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:8px 14px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#1d4ed8}
    /* Multiplayer panels */
    .mpPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #334155;border-radius:12px;padding:16px 18px;color:#e5e7eb;min-width:320px;display:none}
    .mpTitle{font:18px/1.3 system-ui,sans-serif;margin-bottom:10px}
    .mpRow{margin:8px 0}
    .inp{width:100%;padding:8px 10px;border:1px solid #334155;border-radius:8px;background:#0f172a;color:#e5e7eb;font-size:18px;letter-spacing:2px;text-align:center}
    .badge{display:inline-block;padding:4px 8px;border:1px solid #334155;border-radius:8px;background:#0f172a;margin-left:8px}
    .mpList{border:1px dashed #334155; border-radius:8px; padding:8px 10px; font:14px system-ui,sans-serif; min-height:60px; white-space:pre-line}
    .kbd{display:inline-block;background:#111827;border:1px solid #334155;border-radius:6px;padding:2px 6px;margin-left:6px;color:#e5e7eb}
  </style>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div id="root"><canvas id="game" width="960" height="540" tabindex="0"></canvas></div>
  <div class="hint">WASD/стрелки — движение • ЛКМ — хук (через 3.5с) • M — меню • R — рестарт • Мультиплеер работает на HTTPS (GitHub Pages)</div>
  <div id="pickup" class="pickup"></div>
  <button id="btnMenu" class="menuBtn">Главное меню</button>
  <div id="menuPanel" class="menuPanel">
    <div class="tabs">
      <div data-tab="main" class="tab active">Главная</div>
      <div data-tab="profile" class="tab">Профиль</div>
    </div>
    <div class="tabBody" id="tabMain">Добро пожаловать в Hook Arena! Нажми «Играть» (бот) или <b>«Мультиплеер»</b>.</div>
    <div class="tabBody" id="tabProfile" style="display:none">Профиль игрока (заглушка).</div>
  </div>
  <div class="skillbar">
    <div class="skill" id="hookSkill">
      <img alt="Hook" src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='48' height='48' rx='8' ry='8' fill='%231f2937'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Verdana' font-size='22' fill='%23e5e7eb'>H</text></svg>"/>
      <div class="cdtimer" style="display:none"></div>
    </div>
  </div>
  <div class="hud" id="hud"></div>

  <!-- MP panels -->
  <div id="mpMenu" class="mpPanel">
    <div class="mpTitle">Мультиплеер</div>
    <div class="actions">
      <button class="btn primary" id="btnHost">Создать лобби</button>
      <button class="btn" id="btnJoin">Присоединиться</button>
      <button class="btn" id="btnCloseMp">Назад</button>
    </div>
    <div class="mpRow" style="opacity:.8">Поделитесь кодом с другом или введите код друга, чтобы подключиться.</div>
  </div>

  <div id="mpHost" class="mpPanel">
    <div class="mpTitle">Лобби (host: <b>admin</b>) <span id="roomBadge" class="badge"></span></div>
    <div class="mpRow">Код комнаты: <b id="roomCode">-----</b></div>
    <div class="mpRow">Игроки:</div>
    <div id="hostPlayers" class="mpList">admin (ты)</div>
    <div class="actions" style="margin-top:10px">
      <button class="btn primary" id="btnStartMp" disabled>Начать игру</button>
      <button class="btn" id="btnHostBack">Назад</button>
    </div>
    <div id="hostStatus" class="mpRow" style="opacity:.8"></div>
  </div>

  <div id="mpJoin" class="mpPanel">
    <div class="mpTitle">Присоединиться как <b>user</b></div>
    <div class="mpRow">
      <input id="joinCode" class="inp" placeholder="Код комнаты (5 цифр)" maxlength="5"
             type="tel" inputmode="numeric" pattern="\\d{5}" autocomplete="one-time-code" />
    </div>
    <div class="actions">
      <button class="btn primary" id="btnJoinGo">Присоединиться</button>
      <button class="btn" id="btnJoinBack">Назад</button>
    </div>
    <div class="mpRow" style="opacity:.8">Подсказка: на мобилках откроется цифровая клавиатура. На десктопе можно вводить цифры с клавиатуры.</div>
    <div id="joinStatus" class="mpRow" style="opacity:.9"></div>
  </div>

  <script>
  (()=>{
    const W=960, H=540;
    const MID=W/2, RIVER_FR=0.40, RIVER_W=Math.floor(W*RIVER_FR), RIVER_HALF=Math.floor(RIVER_W/2);
    const LEFT_BANK_X=MID-RIVER_HALF, RIGHT_BANK_X=MID+RIVER_HALF;
    const PLAYER_SPEED=260, HOOK_SPEED=1100, PULL_SPEED=380, BLOCK_TIME=3500;
    const ENEMY_SIDE_LEFT = LEFT_BANK_X, ENEMY_SIDE_RIGHT = W - RIGHT_BANK_X;
    const BASE_RANGE_PLAYER = RIVER_W + ENEMY_SIDE_LEFT/3;
    const BASE_RANGE_BOT    = RIVER_W + ENEMY_SIDE_RIGHT/3;
    const FOG_ALPHA_HIDDEN=0.9, FOG_ALPHA_SEEN=0.15;
    const MP_ENABLED = (location.protocol==='https:' || location.hostname==='localhost');

    const canvas=document.getElementById('game'), ctx=canvas.getContext('2d');
    function focusCanvas(){ canvas.focus({preventScroll:true}); }
    focusCanvas();
    ['pointerdown','click','focus'].forEach(ev=>window.addEventListener(ev, focusCanvas));

    const hud=document.getElementById('hud');
    const hookSkillEl=document.getElementById('hookSkill'), hookSkillTimerEl=hookSkillEl.querySelector('.cdtimer');
    const btnMenu=document.getElementById('btnMenu'), panel=document.getElementById('menuPanel');
    const tabMain=document.getElementById('tabMain'), tabProfile=document.getElementById('tabProfile');
    const tabs=[...panel.querySelectorAll('.tab')];
    const pickupEl=document.getElementById('pickup');

    // MP DOM
    const mpMenu=document.getElementById('mpMenu');
    const mpHost=document.getElementById('mpHost');
    const mpJoin=document.getElementById('mpJoin');
    const btnHost=document.getElementById('btnHost');
    const btnJoin=document.getElementById('btnJoin');
    const btnCloseMp=document.getElementById('btnCloseMp');
    const btnHostBack=document.getElementById('btnHostBack');
    const btnJoinBack=document.getElementById('btnJoinBack');
    const btnJoinGo=document.getElementById('btnJoinGo');
    const joinCodeEl=document.getElementById('joinCode');
    const joinStatus=document.getElementById('joinStatus');
    const hostPlayers=document.getElementById('hostPlayers');
    const hostStatus=document.getElementById('hostStatus');
    const roomCodeEl=document.getElementById('roomCode');
    const roomBadge=document.getElementById('roomBadge');
    const btnStartMp=document.getElementById('btnStartMp');

    let screen='menu', globalLevel=1, stats={wins:0, loses:0};

    btnMenu.onclick=()=>{ panel.style.display = (panel.style.display==='block'?'none':'block') };
    tabs.forEach(t=>t.onclick=()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const name=t.dataset.tab;
      if(name==='main'){ screen='menu'; }
      tabMain.innerHTML = `Добро пожаловать в Hook Arena! Нажми «Играть» (бот) или <b>«Мультиплеер»</b>.`;
      tabMain.appendChild(buildMainButtons());
      tabMain.style.display=(name==='main')?'block':'none';
      tabProfile.style.display=(name==='profile')?'block':'none';
      tabProfile.textContent=`Профиль: побед ${stats.wins}, поражений ${stats.loses}, глоб. сложность ${globalLevel}`;
    });

    function buildMainButtons(){
      const wrap=document.createElement('div'); wrap.style.marginTop='10px';
      const btnPlay=document.createElement('button'); btnPlay.className='btn primary'; btnPlay.textContent='Играть (бот)';
      const btnMP=document.createElement('button'); btnMP.className='btn'; btnMP.style.marginLeft='8px'; btnMP.textContent='Мультиплеер';
      btnPlay.onclick=()=>{ startMatchSP(); };
      btnMP.onclick=()=>{
        if(!MP_ENABLED || !window.Peer){
          alert('Мультиплеер работает только на GitHub Pages (HTTPS). Сейчас доступен офлайн-режим.');
          return;
        }
        openMpMenu();
      };
      wrap.appendChild(btnPlay); wrap.appendChild(btnMP);
      return wrap;
    }

    function openMpMenu(){ mpMenu.style.display='block'; mpHost.style.display='none'; mpJoin.style.display='none'; }
    function closeMpPanels(){ mpMenu.style.display='none'; mpHost.style.display='none'; mpJoin.style.display='none'; }
    btnCloseMp.onclick=closeMpPanels;
    btnHost.onclick=()=>{ createLobby(); };
    btnJoin.onclick=()=>{
      mpMenu.style.display='none'; mpJoin.style.display='block'; joinStatus.textContent='';
      // Trigger soft keyboard on mobile
      setTimeout(()=>{
        joinCodeEl.focus({preventScroll:true});
        joinCodeEl.select && joinCodeEl.select();
      }, 50);
    };
    btnHostBack.onclick=()=>{ closeMpPanels(); };
    btnJoinBack.onclick=()=>{ openMpMenu(); };

    // Numeric-only guard
    joinCodeEl.addEventListener('input', ()=>{
      joinCodeEl.value = (joinCodeEl.value||'').replace(/\D+/g,'').slice(0,5);
    });
    joinCodeEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ btnJoinGo.click(); }
    });

    // ======= (Game/MP engine trimmed for brevity) =======
    // For this r9 diff, the only change vs r8 is the join UX. The full engine is identical to r8.
    // To keep this answer compact, I'll include a minimal SP stub so you can run file locally.

    function startMatchSP(){
      // simple placeholder to prove file runs; in your repo keep the full r8 engine file.
      alert('Singleplayer тест-заглушка в r9: основной игровой код без изменений с r8. В репо используйте r8/r10 с полным движком.');
      closeMpPanels();
    }

    // MP: create/join lobby (same as r8, only focus behavior changed)
    let peer=null, conn=null, roomCode=null;
    function makeRoomCode(){ return String(Math.floor(10000+Math.random()*90000)) }
    function roomIdFromCode(code){ return 'hookarena-'+code }
    function createLobby(){
      openMpMenu(); mpMenu.style.display='none'; mpHost.style.display='block'; hostPlayers.textContent='admin (ты)'; hostStatus.textContent='';
      roomCode = makeRoomCode();
      roomCodeEl.textContent = roomCode;
      roomBadge.textContent = 'код действует пока ты в лобби';
      const peerId = roomIdFromCode(roomCode);
      try{
        peer = new Peer(peerId, { debug: 1 });
        peer.on('open', id => { hostStatus.textContent='Ожидание подключения...'; });
        peer.on('connection', c => {
          conn = c; hostStatus.textContent='Игрок подключился (user)'; hostPlayers.textContent='admin (ты)\nuser';
          conn.on('data', (msg)=>{});
          conn.on('close', ()=>{ hostStatus.textContent='Игрок отключился'; btnStartMp.disabled=true; hostPlayers.textContent='admin (ты)'; });
          btnStartMp.disabled=false;
        });
        peer.on('error', err => { hostStatus.textContent='Ошибка: '+err; });
      }catch(e){ hostStatus.textContent='PeerJS не доступен (нужен HTTPS).'; }
    }
    btnStartMp.onclick=()=>{ alert('Старт MP игры (заглушка r9). На GH Pages используйте полную версию (r8/r10).'); };

    btnJoinGo.onclick=()=>{
      const code = (joinCodeEl.value||'').trim();
      if(!/^\d{5}$/.test(code)){ joinStatus.textContent='Введите 5 цифр.'; return; }
      joinStatus.textContent='Подключение...';
      try{
        peer = new Peer(undefined, { debug: 1 });
        peer.on('open', id => {
          const idHost = roomIdFromCode(code);
          conn = peer.connect(idHost);
          conn.on('open', ()=>{ joinStatus.textContent='Подключено! Ожидаем старт.'; });
          conn.on('error', err=>{ joinStatus.textContent='Ошибка соединения: '+err });
          conn.on('close', ()=>{ joinStatus.textContent='Соединение закрыто'; });
        });
        peer.on('error', err => { joinStatus.textContent='Ошибка Peer: '+err });
      }catch(e){ joinStatus.textContent='PeerJS не доступен (нужен HTTPS).'; }
    };

    // Init first tab
    tabs[0].click();
  })();
  </script>
</body>
</html>
